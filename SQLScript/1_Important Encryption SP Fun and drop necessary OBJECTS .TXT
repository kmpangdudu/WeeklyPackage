---  1) FUll backup from T530
---    backup by using sa
---    backup database RAM to disk='D:\Users\erjun\Documents\Test\RAM\RAM_DB_20160302.bak'
---
--     restore
---    USE [master]
---    
---    IF EXISTS (SELECT name FROM master.sys.databases WHERE name = N'RAM') 
---			BEGIN 
---				ALTER DATABASE RAM set single_user with rollback immediate
---				
---				DROP DATABASE RAM  
---				
---			END
---		ELSE
---			BEGIN
---				CREATE DATABASE [RAM]
---				
---				ALTER DATABASE [RAM] MODIFY FILE
---				( NAME = N'RAM' , SIZE = 512MB , MAXSIZE = UNLIMITED, FILEGROWTH = 1024KB )
---				
---		
---				ALTER DATABASE [RAM] MODIFY FILE
---				( NAME = N'RAM_log' , SIZE = 256MB , MAXSIZE = UNLIMITED , FILEGROWTH = 10%)
---				

---				ALTER AUTHORIZATION ON DATABASE::YourDatabaseName TO KHPRAM
---				
---			END
---    RESTORE DATABASE RAM FROM DISK='F:\RAM\RAM_DB_20160302.bak'
---    GO
---
---  2) (unnecerssay) Executing: unnecerssay!
--           USE master;
--           GO
--           ALTER DATABASE RAM
--           Modify Name = RAM20160226 ;
---  
---  3) (unnecerssay) COPY 1111_tsglobal.xml to Databas Server:  E:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\FTData
---     or edit it on the server
---
---  4) (unnecerssay) rename 1111_tsglobal.xml  to tsglobal.xml
---
---  5) Run:  Below script to remove all unnecerssay SP, Functions  and encryption all SP
---
---  6) (unnecerssay) Executing to load thesaurus_file
---           USE [RAM20160226]
---           GO
---           EXEC sys.sp_fulltext_load_thesaurus_file 0;
---           GO
---  7) (unnecerssay) Edit Web.Config on the Web Server E:\inetpub\RAM\Web.config
---          changing DB_nameconnecting string:  
---                         catalog=RAM;
---                         user id=KHPRAM;
---                         password=KidsheWC15!
---          Row 16:   <add name="RAMEntities" connectionString="metadata=res://*/EF.RAMModel.csdl|res://*/EF.RAMModel.ssdl|res://*/EF.RAMModel.msl;provider=System.Data.SqlClient;provider connection string=&quot;data source=T530;initial catalog=RAM;persist security info=True;user id=sa;password=12629634Abc;MultipleActiveResultSets=True;App=EntityFramework&quot;" providerName="System.Data.EntityClient"/>
---
---------------------------------------------------------------------------------------
---  8) Changing Subcategory, TopCategory, TaxonomyCode active status will bring below tables changing
---      SubCategory
---      TopCategory 
---      TopCategoryID_SubCategoryID
---      InterestTaxonomy
---      SubcategoryID_InterestTaxonomyID
---------------------------------------------------------------------------------------
---  9) For Production server, User Name : RAMUser; PWD: KidsheWC15!
---                            use SA login, have "RAMUser" point to RAM, give Owner promison
---
---------------------------------------------------------------------------------------


---    USE [master]
---    
---    IF EXISTS (SELECT name FROM master.sys.databases WHERE name = N'RAM') 
---			BEGIN 
---				ALTER DATABASE RAM set single_user with rollback immediate
---				
---				DROP DATABASE RAM  
---				
---			END
---		ELSE
---			BEGIN
---				CREATE DATABASE [RAM]
---				
---				ALTER DATABASE [RAM] MODIFY FILE
---				( NAME = N'RAM' , SIZE = 512MB , MAXSIZE = UNLIMITED, FILEGROWTH = 1024KB )
---				
---		
---				ALTER DATABASE [RAM] MODIFY FILE
---				( NAME = N'RAM_log' , SIZE = 256MB , MAXSIZE = UNLIMITED , FILEGROWTH = 10%)
---				
---				
---				ALTER AUTHORIZATION ON DATABASE::YourDatabaseName TO KHPRAM
---				
---				
---			END
---  --  RESTORE DATABASE RAM FROM DISK='F:\RAM\RAM_DB_20160302.bak'
---	GO















------------------------------
--  Restore database
------------------------------
-- To allow advanced options to be changed.
EXEC sp_configure 'show advanced options', 1
GO
-- To update the currently configured value for advanced options.
RECONFIGURE
GO
-- To enable the feature.
EXEC sp_configure 'xp_cmdshell', 1
GO
-- To update the currently configured value for this feature.
RECONFIGURE
GO
USE [master]
ALTER DATABASE [RAM] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
RESTORE DATABASE [RAM] FROM  DISK = N'E:\RAMAPI\App_Data\DB.bak' WITH  FILE = 1,  NOUNLOAD,  REPLACE,  STATS = 5
ALTER DATABASE [RAM] SET MULTI_USER
GO











--------------------------------------
---
---  Delete backup file from disk
---
--------------------------------------
-- To allow advanced options to be changed.
EXEC sp_configure 'show advanced options', 1
GO
-- To update the currently configured value for advanced options.
RECONFIGURE
GO
-- To enable the feature.
EXEC sp_configure 'xp_cmdshell', 1
GO
-- To update the currently configured value for this feature.
RECONFIGURE
GO
xp_cmdshell 'del /F /Q  E:\RAMAPI\App_Data\DB.*'










USE [RAM]
GO

IF OBJECT_ID('View_ETLloadID_KHPCtaegoryID_ClassificationID_KHPTaxonomyID', 'V') IS NOT NULL
    DROP VIEW View_ETLloadID_KHPCtaegoryID_ClassificationID_KHPTaxonomyID;
GO

IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'CleanHTMLTags') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION CleanHTMLTags
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'InitCap') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION InitCap
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_ram') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_ram
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_Coverage') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_Coverage
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_CustomEligibilitybyAge') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_CustomEligibilitybyAge
GO

IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_GEOCode') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_GEOCode
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_GroupLat') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_GroupLat
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_GroupLat_RAMResource') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_GroupLat_RAMResource
GO

IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_GEOCode') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_GEOCode
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_KEYTaxonomyTerm') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_KEYTaxonomyTerm
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_Splite_TaxonomyTerm') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_Splite_TaxonomyTerm
GO

IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_Splite_TaxonomyTermS') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_Splite_TaxonomyTermS
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_syncLocationInfo') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_syncLocationInfo
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_taxonomyCode') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_taxonomyCode
GO

IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'F_WorkHours') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION F_WorkHours
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'relatedPS') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION relatedPS
GO
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'Test_NewRam_address_etc') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION Test_NewRam_address_etc
GO



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Insert_update_table_SubcategoryID_InterestTaxonomyID')
DROP PROCEDURE Proc_Insert_update_table_SubcategoryID_InterestTaxonomyID
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Insert_update_Table_InterestTaxonomy')
DROP PROCEDURE Proc_Insert_update_Table_InterestTaxonomy
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Insert_Update_Table_TopCategoryID_SubCategoryID')
DROP PROCEDURE Proc_Insert_Update_Table_TopCategoryID_SubCategoryID
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Insert_Update_Table_Subcategory')
DROP PROCEDURE Proc_Insert_Update_Table_Subcategory
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Insert_Update_Table_TopCategory')
DROP PROCEDURE Proc_Insert_Update_Table_TopCategory
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getProvince_FR')
DROP PROCEDURE getProvince_FR
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getProvince_EN')
DROP PROCEDURE getProvince_EN
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'buildRAM')
DROP PROCEDURE buildRAM
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'abc')
DROP PROCEDURE abc
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'z_useless_GetResourceByCategory')
DROP PROCEDURE z_useless_GetResourceByCategory
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'GeneratInterestingTaxonomyBridge')
DROP PROCEDURE GeneratInterestingTaxonomyBridge
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getAllMap')
DROP PROCEDURE getAllMap
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getAllMapEN')
DROP PROCEDURE getAllMapEN
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getAllMapFR')
DROP PROCEDURE getAllMapFR
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Construct_RAMResource')
DROP PROCEDURE Proc_Construct_RAMResource
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'new_lookup_process')
DROP PROCEDURE new_lookup_process
GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_All_Pinned')
DROP PROCEDURE Proc_Get_All_Pinned
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'RAM_To_Pined')
DROP PROCEDURE RAM_To_Pined
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'spGeocode')
DROP PROCEDURE spGeocode
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'spGeocode_LatLongi')
DROP PROCEDURE spGeocode_LatLongi
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'splite_map_and_WP_1')
DROP PROCEDURE splite_map_and_WP_1
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'z_ENCRYPTION_test1')
DROP PROCEDURE z_ENCRYPTION_test1
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_WorkHours_by_EtlloadID')
DROP PROCEDURE Proc_Get_WorkHours_by_EtlloadID
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'InterestTaxonomyCode_Splite')
DROP PROCEDURE InterestTaxonomyCode_Splite
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'insertNewRAM_and_flag_map')
DROP PROCEDURE insertNewRAM_and_flag_map
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'insertNewRAM_and_flag_map')
DROP PROCEDURE insertNewRAM_and_flag_map
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getShelterByCityIDCateID')
DROP PROCEDURE getShelterByCityIDCateID
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getPWNameByCityIDCateID')
DROP PROCEDURE getPWNameByCityIDCateID
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getPWByCityIDCateID')
DROP PROCEDURE getPWByCityIDCateID
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getMapByCategories')
DROP PROCEDURE getMapByCategories
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getMapByCategoriesEN')
DROP PROCEDURE getMapByCategoriesEN
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getMapByCategoriesFR')
DROP PROCEDURE getMapByCategoriesFR
GO












-- =======================================================================================================================================
-- Author:		William Chen
-- Create date: Nov.8, 2015 
-- Description:	using cluster to do the fuzzy search
-- Revision: Feb.1, 2016, 
--           added freetext(*,@PressLetter);
--           changed "AND" to "OR"
--           Changed @T_Result NVARCHAR(2000) to NVARCHAR(MAX)
--           Changed  @K1 from NVARCHAR(50) to  NVARCHAR(255)
--           Changed @SearchWordS from NVARCHAR(2000) to NVARCHAR(MAX)
--           Changed @PressLetter from NVARCHAR(2000) to NVARCHAR(4000) ;
-- Revision: Feb10,2016
--           comment CASE c.CityName WHEN 'TBD' THEN ........ END AS PublicNames
--           comment a.PhysicalAddressIsPrivate
--			Mar.10, 2016 re-organized select columns
-- Revision : Apr.10, 2016
--            changed last select statement where clust add   SC.Active = 1   AND   TC.Active = 1 into where cluster
--            so lt read : (WHERE a.LanguageOfRecord = @lang  AND  SC.Active = 1   AND   TC.Active = 1) 
-- Revision: Aug.17, 2016. 
--				Add parameter @token to check access control list
-- =======================================================================================================================================
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Cluster_Search')
DROP PROCEDURE Proc_Cluster_Search
GO

CREATE PROCEDURE [dbo].[Proc_Cluster_Search]
	-- Add the parameters for the stored procedure here
@SearchWordS NVARCHAR(MAX) = N' ',
@lang NVARCHAR(50) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SET ansi_warnings OFF;
--------------------------------------------------------------
-- Searched raw results put in this table variable 
--------------------------------------------------------------
	DECLARE @T_Result TABLE
	(
	etlloadid int ,
	PublicNames NVARCHAR(MAX)  ,
	AgencyDescription NVARCHAR(MAX)  ,
	PhysicalAddress NVARCHAR(MAX)  ,
	City NVARCHAR(MAX)  ,
	Province NVARCHAR(MAX)  ,
	STerm NVARCHAR(MAX)  ,
	LTerms NVARCHAR(MAX)  
	)

--------------------------------------------------------------
-- Allowing access TopCategory list put in table variable 
--------------------------------------------------------------
DECLARE @allow_TopCategory TABLE
(
ATID int
)





-------------------------------------------------------------
-- @PressLetter IS PERPARED FOR FREETEXT SEARCHINH
-------------------------------------------------------------
	DECLARE @PressLetter NVARCHAR(4000) ;
	SELECT @PressLetter = @SearchWordS ;


 --------------------------------------------------------------------------------------------------
 --- Create a table variable @T_KEYWORD. The @T_KEYWORD will be used to handle splited keywords
 --------------------------------------------------------------------------------------------------
DECLARE @T_KEYWORD TABLE
(
ID int IDENTITY(1,1) NOT NULL,
KeyWord NVARCHAR(255)  
)


 ---------------------------------- ---------------------------------- ----------------------------------
 -- DECLARE Key word group. Each @k1..@k11 will set a splited user's input
 ---------------------------------- ---------------------------------- ----------------------------------
 DECLARE @K1  NVARCHAR(255);
 DECLARE @K2  NVARCHAR(255);
 DECLARE @K3  NVARCHAR(255);
 DECLARE @K4  NVARCHAR(255);
 DECLARE @K5  NVARCHAR(255);
 DECLARE @K6  NVARCHAR(255);
 DECLARE @K7  NVARCHAR(255);
 DECLARE @K8  NVARCHAR(255);
 DECLARE @K9  NVARCHAR(255);
 DECLARE @K10 NVARCHAR(255);
 DECLARE @K11 NVARCHAR(255);


-----------------------------------------------------------------------------------------------------------
-- Augest 17, 2016 added to check users input keyword whether or not in double quotation 
-- If use input keywords is in double quotation mark, we will trade it as a whole phrase to be searched   
-----------------------------------------------------------------------------------------------------------
DECLARE @ToBeCheckedKWS NVARCHAR(4000);
SET  @ToBeCheckedKWS = [dbo].[F_Extract_Text_Between_Quotation] (@SearchWordS);

IF LEN(@ToBeCheckedKWS) > 0 -- user input keywords in a double quotation pair, will trade it as a whole keyword
	BEGIN
		SET  @SearchWordS = @ToBeCheckedKWS;
		SET  @PressLetter = @ToBeCheckedKWS;

		INSERT INTO  @T_KEYWORD  (KEYWORD) VALUES(@SearchWordS);

		--  constructing freetext search contain 
		SELECT @K1  =  CONCAT('FORMSOF (THESAURUS,"', KeyWord , '")','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  1 ;  
	END
ELSE  -- user input multiple keywords, will process those words into @k1--@k11
	BEGIN
		--------------------------------------------------------------------------
		---  replace unnecessary char
		--------------------------------------------------------------------------
		 SELECT @SearchWordS = RTRIM(LTRIM(@SearchWordS)) ;
		--- remove last ";" or "space"
		 Select @SearchWordS = SUBSTRING(@SearchWordS, 0, LEN(@SearchWordS)+1) ;
		 --- "," comma convert to ";"
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,',',';') ;
		  --- "." period convert to ";"					   
		 --SELECT @SearchWordS =  REPLACE(@SearchWordS,'.',';') ;
		   --- "：" colon convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,':',';') ;
		 --- "("  convert to ";"					   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'(',';') ;
		  --- ")"  convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,')',';') ;
		  --- "["  convert to ";"					   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'[',';') ;
		  --- "]"  convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,']',';') ;
		 --- "*" convert to ";"							  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'*',';') ;
		 --- "-" dash  convert to ";"					   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'-',';') ;
		  --- " " space convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,' ',';') ;
		   --- "/" convert to ";"						  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'/',';') ;
			--- "_" convert to ";"						   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'_',';') ;
			 --- "|" convert to ";"						   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'|',';') ;
		 ------------------------------------------------------------------------

		-----------------------------------------------------------------------------------------
		-- Split Search keywords by semi colon ";" then insert into Table varibale @T_KEYWORD
		----------------------------------------------------------------------------------------
		  --数据分隔符
		 DECLARE @splitlen int;
		 SET @splitlen=LEN(';'+'a')-2;


 
		 WHILE CHARINDEX(';',@SearchWordS)>0
			 BEGIN

				IF (
					NOT EXISTS (SELECT KEYWORD FROM @T_KEYWORD WHERE KEYWORD =   LEFT(@SearchWordS,CHARINDEX(';',@SearchWordS)-1))
					AND LEN(LEFT(@SearchWordS,CHARINDEX(';',@SearchWordS)-1) ) > 0
				   )
					INSERT INTO  @T_KEYWORD  (KEYWORD) VALUES(LEFT(@SearchWordS,CHARINDEX(';',@SearchWordS)-1) )  ;
 
				SET @SearchWordS=RTRIM(LTRIM(STUFF(@SearchWordS,1,CHARINDEX(';',@SearchWordS)+@splitlen,'')));
 
			 END;

		 IF ( NOT EXISTS (SELECT KEYWORD FROM  @T_KEYWORD WHERE KEYWORD = @SearchWordS) 
				AND 
				LEN(@SearchWordS) > 0
			)
		 INSERT INTO  @T_KEYWORD  (KEYWORD) VALUES(@SearchWordS);

		  ----------------------------------------------------------------------------------------------------------
		 -- Extract splited search keywords from Table variable @T_KEYWORD, then constructing CONTAIN textsearch 
		 ----------------------------------------------------------------------------------------------------------
			SELECT @K1  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  1 ;  
			SELECT @K2  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  2 ;  
			SELECT @K3  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  3 ;  
			SELECT @K4  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  4 ;  
			SELECT @K5  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  5 ;  
			SELECT @K6  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  6 ;  
			SELECT @K7  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  7 ;  
			SELECT @K8  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  8 ;  
			SELECT @K9  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  9 ;  
			SELECT @K10  = CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 10 ;  
			SELECT @K11  = CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 11 ; 



			-----------------------------------------------
			-- Feb.1, 2016, add freetext(*,@SearchWordS)
			-----------------------------------------------
 
			IF (@PressLetter IS NOT NULL) AND (@PressLetter != '') AND (@PressLetter != ' ')
					INSERT INTO @T_Result
						SELECT  DISTINCT etlloadid
						, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p> '+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames] 
						, [AgencyDescription]
						, [PhysicalAddress]
						, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
						, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]													 
						, taxonomyterm AS STerm
						, taxonomyterms AS LTerms
						FROM keywords 
						WHERE  FREETEXT(*, @PressLetter) ;

 END  -- END OF processing user inputed keywords into @k1--@k11



 
 --SELECT @K1  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  1 ;
 --SELECT @K2  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  2 ;
 --SELECT @K3  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  3 ;
 --SELECT @K4  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  4 ;
 --SELECT @K5  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  5 ;
 --SELECT @K6  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  6 ;
 --SELECT @K7  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  7 ;
 --SELECT @K8  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  8 ;
 --SELECT @K9  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  9 ;
 --SELECT @K10 = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 10 ;
 --SELECT @K11 = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 11 ;







 
 
 	------------------------------------------------------------
	-- beginning fulltext CONTAIN search
	------------------------------------------------------------

BEGIN TRY
 
  
IF (@k11 IS NOT NULL) AND (@K11 != '')
	BEGIN
	 INSERT INTO @T_Result
			SELECT  DISTINCT etlloadid
			, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS PublicNames
			, [AgencyDescription] 
			, [PhysicalAddress]
			, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
			, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
			, taxonomyterm AS STerm
			, taxonomyterms AS LTerms
			FROM keywords 
			  --WHERE CONTAINS(([PublicName],[AgencyDescription],[PhysicalCity],[PhysicalProvince],[TaxonomyTerm],[TaxonomyTerms]), @Searching)
			  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
					CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8) OR 
					CONTAINS(*, @K9) OR CONTAINS(*, @K10) OR CONTAINS(*, @K11);
	END 
	ELSE IF (@k10 IS NOT NULL) AND (@K10 != '')
		BEGIN
		 INSERT INTO @T_Result
				SELECT  DISTINCT etlloadid
				, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
				, [AgencyDescription] 
				, [PhysicalAddress]
				, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
				, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
				, taxonomyterm AS STerm
				, taxonomyterms AS LTerms
				FROM keywords 
				  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
						CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8) OR 
						CONTAINS(*, @K9) OR CONTAINS(*, @K10) ;
		END 
		ELSE IF (@k9 IS NOT NULL) AND (@K9 != '')
			BEGIN
			 INSERT INTO @T_Result
					SELECT  DISTINCT etlloadid
					, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
					, [AgencyDescription]
					, [PhysicalAddress]
					, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
					, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]					 
					, taxonomyterm AS STerm
					, taxonomyterms AS LTerms
					FROM keywords 
					  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
							CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8) OR 
							CONTAINS(*, @K9)  ;
			END 		
			ELSE IF (@k8 IS NOT NULL) AND (@K8 != '')
				BEGIN
				 INSERT INTO @T_Result
						SELECT  DISTINCT etlloadid
						, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
						, [AgencyDescription] 
						, [PhysicalAddress]
						, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
						, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
						, taxonomyterm AS STerm
						, taxonomyterms AS LTerms
						FROM keywords 
						  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
								CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8)  ;
				END 
				ELSE IF (@k7 IS NOT NULL) AND (@K7 != '')
					BEGIN
					 INSERT INTO @T_Result
							SELECT  DISTINCT etlloadid
							, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
							, [AgencyDescription]
							, [PhysicalAddress]
							, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
							, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]							 
							, taxonomyterm AS STerm
							, taxonomyterms AS LTerms
							FROM keywords 
							  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
									CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) ;
					END 
					ELSE IF (@k6 IS NOT NULL) AND (@K6 != '')
						BEGIN
						 INSERT INTO @T_Result
								SELECT  DISTINCT etlloadid
								, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
								, [AgencyDescription] 
								, [PhysicalAddress]
								, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
								, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
								, taxonomyterm AS STerm
								, taxonomyterms AS LTerms
								FROM keywords 
								  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
										CONTAINS(*, @K5) OR CONTAINS(*, @K6) ;
						END 
						ELSE IF (@k5 IS NOT NULL) AND (@K5 != '')
							BEGIN
							 INSERT INTO @T_Result
									SELECT  DISTINCT etlloadid
									, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames] 
									, [AgencyDescription]
									, [PhysicalAddress]
									, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
									, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]									 
									, taxonomyterm AS STerm
									, taxonomyterms AS LTerms
									FROM keywords 
									  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
											CONTAINS(*, @K5) ;
							END
							ELSE IF (@k4 IS NOT NULL) AND (@K4 != '')
								BEGIN
								 INSERT INTO @T_Result
										SELECT  DISTINCT etlloadid
										, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]  
										, [AgencyDescription]
										, [PhysicalAddress]
										, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
										, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]										 
										, taxonomyterm AS STerm
										, taxonomyterms AS LTerms
										FROM keywords 
										  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) ;
								END
								ELSE IF (@k3 IS NOT NULL) AND (@K3 != '')
									BEGIN
									 INSERT INTO @T_Result
											SELECT  DISTINCT etlloadid
											, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
											, [AgencyDescription]
											, [PhysicalAddress]
											, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
											, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]											 
											, taxonomyterm AS STerm
											, taxonomyterms AS LTerms
											FROM keywords 
											  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) ;
									END 
									ELSE IF (@k2 IS NOT NULL) AND (@K2 != '')
										BEGIN
										 INSERT INTO @T_Result
												SELECT  DISTINCT etlloadid
												, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
												, [AgencyDescription]
												, [PhysicalAddress]
												, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
												, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]												 
												, taxonomyterm AS STerm
												, taxonomyterms AS LTerms
												FROM keywords 
												  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2)  ;
										END
										ELSE IF (@k1 IS NOT NULL) AND (@K1 != '')
											BEGIN
											 INSERT INTO @T_Result
													SELECT  DISTINCT etlloadid
													, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p> '+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames] 
													, [AgencyDescription]
													, [PhysicalAddress]
													, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
													, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]													 
													, taxonomyterm AS STerm
													, taxonomyterms AS LTerms
													FROM keywords 
													  WHERE  CONTAINS(*, @K1) ;
											END
											ELSE
												BEGIN
												 INSERT INTO @T_Result
														SELECT  DISTINCT etlloadid
														, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000), '<p>' + publicname+'</p> '+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
														, [AgencyDescription]
														, [PhysicalAddress]
														, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
														, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]														 
														, taxonomyterm AS STerm
														, taxonomyterms AS LTerms
														FROM keywords 
														ORDER BY PublicNames  

												END;

    
END TRY
BEGIN CATCH
 INSERT INTO @T_Result
			SELECT  DISTINCT etlloadid
			, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
			, [AgencyDescription] 
			, [PhysicalAddress]
			, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
			, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
			, taxonomyterm AS STerm
			, taxonomyterms AS LTerms
			FROM keywords 
;
END CATCH
;


-----------------------------------------------
--  Process allow accessing TopCategory List
-----------------------------------------------
--DECLARE @V INT;
--SELECT TOP (1) @V =  p.TopCategoryID  FROM Permission  as p JOIN AccessControlList AS a ON a.ACLID  = p.ACLID WHERE a.ACLToken = @token
--ORDER BY p.TopCategoryID;

--IF @V=0
--	BEGIN -- allow access all of TopCategories
--		INSERT INTO @allow_TopCategory
--			SELECT TOPCATEGORYID FROM [dbo].[TopCategory] WHERE [Active] = 1
--	END
--ELSE  -- allow access specific TopCategories 
--	BEGIN
--		INSERT INTO @allow_TopCategory
--		SELECT DISTINCT p.TopCategoryID AS [ATID] FROM Permission  as p JOIN AccessControlList AS a ON a.ACLID  = p.ACLID WHERE a.ACLToken = @token
--		ORDER BY p.TopCategoryID
--	END








--select 'FREETEXT',* from @T_Result
--------------------------------
-- default langauge is English
--------------------------------
			SELECT DISTINCT    
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				--, CASE K.[City]  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ K.[City]+', '+ K.[Province])	 END  AS PublicNames
                --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
				, a.AgencyDescription
				, K.[PhysicalAddress]
				, [PhysicalCityID]
				, CASE K.[City]  	WHEN 'TBD' THEN '' ELSE K.[City] END AS [City]
				, [PhysicalProvinceID]
				, CASE K.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE K.[Province] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(K.STerm,'/',' ')  AS STerm
				, REPLACE(K.LTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.Coverage
				, a.CoverageArea
				, a.NormalWaitTime
 
			FROM  RamResource   AS a
				JOIN @T_Result AS K ON K.ETLLoadiD = A.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC 		ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC 		ON TC.TopCategoryID = A.TOPCategoryID
				-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
				JOIN  F_Get_Allow_TopCategory (@token) AS ATC 	ON ATC.TOPCategoryID = A.TOPCategoryID 
				-- Return only those resources whose PhysicalCityID is in the allowing City list
				JOIN  F_Get_ALL_Allow_City (@token) AS ACID ON ACID.CityID = A.PhysicalCityID 
			WHERE ---a.LanguageOfRecord = @lang   AND  
					SC.Active = 1   AND   TC.Active = 1
			
			ORDER BY        
				--a.PhysicalProvinceID, 
				--a.PhysicalCityID, 
				--a.TOPCategoryID,  
				--a.SubCategoryID, 
				a.Map






	-----------------
	--  END OF THE SP
	-----------------

END
GO
















-- =======================================================================================================================================
-- Author:		William Chen
-- Create date: Nov.8, 2015 
-- Description:	using cluster to do the fuzzy search
-- Revision: Mar.10, 2016, 
--           the logic is the same as Proc_Cluster_Search
--           but cut the return fields
-- Revision:  Apr.10, 2016
--            changed last select statement, add (  AND  SC.Active = 1   AND   TC.Active = 1) into where cluste  
--            it will read : (WHERE a.LanguageOfRecord = @lang   AND  SC.Active = 1   AND   TC.Active = 1)
--            
-- =======================================================================================================================================

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Cluster_Search_Short')
DROP PROCEDURE Proc_Cluster_Search_Short
GO

CREATE PROCEDURE [dbo].[Proc_Cluster_Search_Short]
	-- Add the parameters for the stored procedure here
@SearchWordS NVARCHAR(MAX) = N' ',
@lang NVARCHAR(50) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SET ansi_warnings OFF;
--------------------------------------------------------------
-- Searched raw results put in this table variable 
--------------------------------------------------------------
	DECLARE @T_Result TABLE
	(
	etlloadid int ,
	PublicNames NVARCHAR(MAX)  ,
	AgencyDescription NVARCHAR(MAX)  ,
	PhysicalAddress NVARCHAR(MAX)  ,
	City NVARCHAR(MAX)  ,
	Province NVARCHAR(MAX)  ,
	STerm NVARCHAR(MAX)  ,
	LTerms NVARCHAR(MAX)  
	)

--------------------------------------------------------------
-- Allowing access TopCategory list put in table variable 
--------------------------------------------------------------
DECLARE @allow_TopCategory TABLE
(
ATID int
)





-------------------------------------------------------------
-- @PressLetter IS PERPARED FOR FREETEXT SEARCHINH
-------------------------------------------------------------
	DECLARE @PressLetter NVARCHAR(4000) ;
	SELECT @PressLetter = @SearchWordS ;


 --------------------------------------------------------------------------------------------------
 --- Create a table variable @T_KEYWORD. The @T_KEYWORD will be used to handle splited keywords
 --------------------------------------------------------------------------------------------------
DECLARE @T_KEYWORD TABLE
(
ID int IDENTITY(1,1) NOT NULL,
KeyWord NVARCHAR(255)  
)


 ---------------------------------- ---------------------------------- ----------------------------------
 -- DECLARE Key word group. Each @k1..@k11 will set a splited user's input
 ---------------------------------- ---------------------------------- ----------------------------------
 DECLARE @K1  NVARCHAR(255);
 DECLARE @K2  NVARCHAR(255);
 DECLARE @K3  NVARCHAR(255);
 DECLARE @K4  NVARCHAR(255);
 DECLARE @K5  NVARCHAR(255);
 DECLARE @K6  NVARCHAR(255);
 DECLARE @K7  NVARCHAR(255);
 DECLARE @K8  NVARCHAR(255);
 DECLARE @K9  NVARCHAR(255);
 DECLARE @K10 NVARCHAR(255);
 DECLARE @K11 NVARCHAR(255);


-----------------------------------------------------------------------------------------------------------
-- Augest 9, 2016 added to check users input keyword whether or not in double quotation 
-- If use input keywords is in double quotation mark, we will trade it as a whole phrase to be searched   
-----------------------------------------------------------------------------------------------------------
DECLARE @ToBeCheckedKWS NVARCHAR(4000);
SET  @ToBeCheckedKWS = [dbo].[F_Extract_Text_Between_Quotation] (@SearchWordS);

IF LEN(@ToBeCheckedKWS) > 0 -- user input keywords in a double quotation pair, will trade it as a whole keyword
	BEGIN
		SET  @SearchWordS = @ToBeCheckedKWS;
		SET  @PressLetter = @ToBeCheckedKWS;

		INSERT INTO  @T_KEYWORD  (KEYWORD) VALUES(@SearchWordS);

		--  constructing freetext search contain 
		SELECT @K1  =  CONCAT('FORMSOF (THESAURUS,"', KeyWord , '")','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  1 ;  
	END
ELSE  -- user input multiple keywords, will process those words into @k1--@k11
	BEGIN
		--------------------------------------------------------------------------
		---  replace unnecessary char
		--------------------------------------------------------------------------
		 SELECT @SearchWordS = RTRIM(LTRIM(@SearchWordS)) ;
		--- remove last ";" or "space"
		 Select @SearchWordS = SUBSTRING(@SearchWordS, 0, LEN(@SearchWordS)+1) ;
		 --- "," comma convert to ";"
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,',',';') ;
		  --- "." period convert to ";"					   
		 --SELECT @SearchWordS =  REPLACE(@SearchWordS,'.',';') ;
		   --- "：" colon convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,':',';') ;
		 --- "("  convert to ";"					   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'(',';') ;
		  --- ")"  convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,')',';') ;
		  --- "["  convert to ";"					   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'[',';') ;
		  --- "]"  convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,']',';') ;
		 --- "*" convert to ";"							  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'*',';') ;
		 --- "-" dash  convert to ";"					   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'-',';') ;
		  --- " " space convert to ";"					  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,' ',';') ;
		   --- "/" convert to ";"						  
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'/',';') ;
			--- "_" convert to ";"						   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'_',';') ;
			 --- "|" convert to ";"						   
		 SELECT @SearchWordS =  REPLACE(@SearchWordS,'|',';') ;
		 ------------------------------------------------------------------------



 
		-----------------------------------------------------------------------------------------
		-- Split Search keywords by semi colon ";" then insert into Table varibale @T_KEYWORD
		----------------------------------------------------------------------------------------
		  --数据分隔符
		 DECLARE @splitlen int;
		 SET @splitlen=LEN(';'+'a')-2;

		 WHILE CHARINDEX(';',@SearchWordS)>0
			 BEGIN

				IF (
					NOT EXISTS (SELECT KEYWORD FROM @T_KEYWORD WHERE KEYWORD =   LEFT(@SearchWordS,CHARINDEX(';',@SearchWordS)-1))
					AND LEN(LEFT(@SearchWordS,CHARINDEX(';',@SearchWordS)-1) ) > 0
				   )
					INSERT INTO  @T_KEYWORD  (KEYWORD) VALUES(LEFT(@SearchWordS,CHARINDEX(';',@SearchWordS)-1) )  ;
 
				SET @SearchWordS=RTRIM(LTRIM(STUFF(@SearchWordS,1,CHARINDEX(';',@SearchWordS)+@splitlen,'')));
 
			 END;

		 IF ( NOT EXISTS (SELECT KEYWORD FROM  @T_KEYWORD WHERE KEYWORD = @SearchWordS) 
				AND 
				LEN(@SearchWordS) > 0
			)
		 INSERT INTO  @T_KEYWORD  (KEYWORD) VALUES(@SearchWordS);

		  ----------------------------------------------------------------------------------------------------------
		 -- Extract splited search keywords from Table variable @T_KEYWORD, then constructing CONTAIN textsearch 
		 ----------------------------------------------------------------------------------------------------------
			SELECT @K1  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  1 ;  
			SELECT @K2  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  2 ;  
			SELECT @K3  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  3 ;  
			SELECT @K4  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  4 ;  
			SELECT @K5  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  5 ;  
			SELECT @K6  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  6 ;  
			SELECT @K7  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  7 ;  
			SELECT @K8  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  8 ;  
			SELECT @K9  =  CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  9 ;  
			SELECT @K10  = CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 10 ;  
			SELECT @K11  = CONCAT('FORMSOF (THESAURUS,', KeyWord , ')','  OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 11 ; 



			-----------------------------------------------
			-- Feb.1, 2016, add freetext(*,@SearchWordS)
			-----------------------------------------------
 
			IF (@PressLetter IS NOT NULL) AND (@PressLetter != '') AND (@PressLetter != ' ')
					INSERT INTO @T_Result
						SELECT  DISTINCT etlloadid
						, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p> '+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames] 
						, [AgencyDescription]
						, [PhysicalAddress]
						, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
						, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]													 
						, taxonomyterm AS STerm
						, taxonomyterms AS LTerms
						FROM keywords 
						WHERE  FREETEXT(*, @PressLetter) ;

 END  -- END OF processing user inputed keywords into @k1--@k11



 
 --SELECT @K1  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  1 ;
 --SELECT @K2  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  2 ;
 --SELECT @K3  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  3 ;
 --SELECT @K4  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  4 ;
 --SELECT @K5  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  5 ;
 --SELECT @K6  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  6 ;
 --SELECT @K7  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  7 ;
 --SELECT @K8  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  8 ;
 --SELECT @K9  = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID =  9 ;
 --SELECT @K10 = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 10 ;
 --SELECT @K11 = CONCAT('"' , KeyWord , '" OR "' , KeyWord , '*"')     FROM  @T_KEYWORD  WHERE ID = 11 ;








 
 
 	------------------------------
	-- beginning fulltext CONTAIN search
	------------------------------

BEGIN TRY
 
  
		IF (@k11 IS NOT NULL) AND (@K11 != '')
		BEGIN
		 INSERT INTO @T_Result
				SELECT  DISTINCT etlloadid
				, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS PublicNames
				, [AgencyDescription] 
				, [PhysicalAddress]
				, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
				, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
				, taxonomyterm AS STerm
				, taxonomyterms AS LTerms
				FROM keywords 
				  --WHERE CONTAINS(([PublicName],[AgencyDescription],[PhysicalCity],[PhysicalProvince],[TaxonomyTerm],[TaxonomyTerms]), @Searching)
				  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
						CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8) OR 
						CONTAINS(*, @K9) OR CONTAINS(*, @K10) OR CONTAINS(*, @K11);
		END 
		ELSE IF (@k10 IS NOT NULL) AND (@K10 != '')
			BEGIN
			 INSERT INTO @T_Result
					SELECT  DISTINCT etlloadid
					, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
					, [AgencyDescription] 
					, [PhysicalAddress]
					, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
					, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
					, taxonomyterm AS STerm
					, taxonomyterms AS LTerms
					FROM keywords 
					  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
							CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8) OR 
							CONTAINS(*, @K9) OR CONTAINS(*, @K10) ;
			END 
			ELSE IF (@k9 IS NOT NULL) AND (@K9 != '')
				BEGIN
				 INSERT INTO @T_Result
						SELECT  DISTINCT etlloadid
						, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
						, [AgencyDescription]
						, [PhysicalAddress]
						, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
						, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]					 
						, taxonomyterm AS STerm
						, taxonomyterms AS LTerms
						FROM keywords 
						  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
								CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8) OR 
								CONTAINS(*, @K9)  ;
				END 		
				ELSE IF (@k8 IS NOT NULL) AND (@K8 != '')
					BEGIN
					 INSERT INTO @T_Result
							SELECT  DISTINCT etlloadid
							, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
							, [AgencyDescription] 
							, [PhysicalAddress]
							, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
							, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
							, taxonomyterm AS STerm
							, taxonomyterms AS LTerms
							FROM keywords 
							  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
									CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) OR CONTAINS(*, @K8)  ;
					END 
					ELSE IF (@k7 IS NOT NULL) AND (@K7 != '')
						BEGIN
						 INSERT INTO @T_Result
								SELECT  DISTINCT etlloadid
								, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
								, [AgencyDescription]
								, [PhysicalAddress]
								, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
								, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]							 
								, taxonomyterm AS STerm
								, taxonomyterms AS LTerms
								FROM keywords 
								  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
										CONTAINS(*, @K5) OR CONTAINS(*, @K6) OR CONTAINS(*, @K7) ;
						END 
						ELSE IF (@k6 IS NOT NULL) AND (@K6 != '')
							BEGIN
							 INSERT INTO @T_Result
									SELECT  DISTINCT etlloadid
									, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
									, [AgencyDescription] 
									, [PhysicalAddress]
									, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
									, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
									, taxonomyterm AS STerm
									, taxonomyterms AS LTerms
									FROM keywords 
									  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
											CONTAINS(*, @K5) OR CONTAINS(*, @K6) ;
							END 
							ELSE IF (@k5 IS NOT NULL) AND (@K5 != '')
								BEGIN
								 INSERT INTO @T_Result
										SELECT  DISTINCT etlloadid
										, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames] 
										, [AgencyDescription]
										, [PhysicalAddress]
										, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
										, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]									 
										, taxonomyterm AS STerm
										, taxonomyterms AS LTerms
										FROM keywords 
										  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) OR 
												CONTAINS(*, @K5) ;
								END
								ELSE IF (@k4 IS NOT NULL) AND (@K4 != '')
									BEGIN
									 INSERT INTO @T_Result
											SELECT  DISTINCT etlloadid
											, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]  
											, [AgencyDescription]
											, [PhysicalAddress]
											, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
											, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]										 
											, taxonomyterm AS STerm
											, taxonomyterms AS LTerms
											FROM keywords 
											  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) OR CONTAINS(*, @K4) ;
									END
									ELSE IF (@k3 IS NOT NULL) AND (@K3 != '')
										BEGIN
										 INSERT INTO @T_Result
												SELECT  DISTINCT etlloadid
												, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
												, [AgencyDescription]
												, [PhysicalAddress]
												, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
												, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]											 
												, taxonomyterm AS STerm
												, taxonomyterms AS LTerms
												FROM keywords 
												  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2) OR CONTAINS(*, @K3) ;
										END 
										ELSE IF (@k2 IS NOT NULL) AND (@K2 != '')
											BEGIN
											 INSERT INTO @T_Result
													SELECT  DISTINCT etlloadid
													, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
													, [AgencyDescription]
													, [PhysicalAddress]
													, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
													, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]												 
													, taxonomyterm AS STerm
													, taxonomyterms AS LTerms
													FROM keywords 
													  WHERE  CONTAINS(*, @K1) OR CONTAINS(*, @K2)  ;
											END
											ELSE IF (@k1 IS NOT NULL) AND (@K1 != '')
												BEGIN
												 INSERT INTO @T_Result
														SELECT  DISTINCT etlloadid
														, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p> '+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames] 
														, [AgencyDescription]
														, [PhysicalAddress]
														, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
														, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]													 
														, taxonomyterm AS STerm
														, taxonomyterms AS LTerms
														FROM keywords 
														  WHERE  CONTAINS(*, @K1) ;
												END
												ELSE
													BEGIN
													 INSERT INTO @T_Result
															SELECT  DISTINCT etlloadid
															, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000), '<p>' + publicname+'</p> '+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
															, [AgencyDescription]
															, [PhysicalAddress]
															, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
															, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]														 
															, taxonomyterm AS STerm
															, taxonomyterms AS LTerms
															FROM keywords 
															ORDER BY PublicNames  

													END;

    
END TRY
BEGIN CATCH
		 INSERT INTO @T_Result
					SELECT  DISTINCT etlloadid
					, CASE physicalcity  	WHEN 'TBD' THEN publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + publicname+'</p>'+ physicalcity+', '+ physicalprovince)	 END  AS [PublicNames]
					, [AgencyDescription] 
					, [PhysicalAddress]
					, CASE physicalcity  	WHEN 'TBD' THEN '' ELSE physicalcity END AS [City]
					, CASE [PhysicalProvince]   WHEN 'OTHS' THEN '' ELSE [PhysicalProvince] END AS [Province]
					, taxonomyterm AS STerm
					, taxonomyterms AS LTerms
					FROM keywords 
		;
END CATCH
;



-----------------------------------------------
--  Process allow accessing TopCategory List
-----------------------------------------------
--DECLARE @V INT;
--SELECT TOP (1) @V =  p.TopCategoryID  FROM Permission  as p JOIN AccessControlList AS a ON a.ACLID  = p.ACLID WHERE a.ACLToken = @token
--ORDER BY p.TopCategoryID;

--IF @V=0
--	BEGIN -- allow access all of TopCategories
--		INSERT INTO @allow_TopCategory
--			SELECT TOPCATEGORYID FROM [dbo].[TopCategory] WHERE [Active] = 1
--	END
--ELSE  -- allow access specific TopCategories 
--	BEGIN
--		INSERT INTO @allow_TopCategory
--		SELECT DISTINCT p.TopCategoryID AS [ATID] FROM Permission  as p JOIN AccessControlList AS a ON a.ACLID  = p.ACLID WHERE a.ACLToken = @token
--		ORDER BY p.TopCategoryID
--	END







--select 'FREETEXT',* from @T_Result
--------------------------------
-- default langauge is English
--------------------------------
			SELECT DISTINCT    
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				--, CASE K.[City]  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ K.[City]+', '+ K.[Province])	 END  AS PublicNames
				--, a.AgencyDescription
				, K.[PhysicalAddress]
				--, [PhysicalCityID]
				, CASE K.[City]  	WHEN 'TBD' THEN '' ELSE K.[City] END AS [City]
				--, [PhysicalProvinceID]
				, CASE K.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE K.[Province] END AS [Province]
				--, a.PhysicalCountry   
				--, a.PhysicalPostalCode
				, REPLACE(K.STerm,'/',' ')  AS STerm
				--, REPLACE(K.LTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				--, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				--, a.Eligibility
				--, a.DisabilitiesAccess
				--, a.FeeStructureSource
				--, a.ApplicationProcess
				--, a.DocumentsRequired
				--, a.LanguagesOfferedList
				--, a.LanguageOfRecord
				--, a.WorkHours
				--, a.CustomEligibilitybyAge
				--, a.changedDate
				--, a.createdDate
 
			FROM  RamResource   AS a
					JOIN @T_Result AS K				ON K.ETLLoadiD = A.ETLLoadID
					JOIN [dbo].[SubCategory] AS SC	ON SC.[SubCategoryID] = A.SubCategoryID
					JOIN [dbo].[TopCategory] AS TC	ON TC.TopCategoryID = A.TOPCategoryID
					-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
				--JOIN  @allow_TopCategory as ATC ON ATC.ATID = A.TOPCategoryID -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
				--JOIN (SELECT * FROM  [dbo].[F_Get_ALL_Allow_City]  (@token) ) AS ACID ON ACID.CityID = A.PhysicalCityID -- Return only those resources whose PhysicalCityID is in the allowing City list
			WHERE ---a.LanguageOfRecord = @lang   AND  
					SC.Active = 1   AND   TC.Active = 1
			
			ORDER BY        
				--a.PhysicalProvinceID, 
				--a.PhysicalCityID, 
				--a.TOPCategoryID,  
				--a.SubCategoryID, 
				a.Map






	-----------------
	--  END OF THE SP
	-----------------

END


go






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Combine_Categories')
DROP PROCEDURE Proc_Get_Combine_Categories
GO
CREATE PROCEDURE [dbo].[Proc_Get_Combine_Categories]
@lang NVARCHAR(20) = N'en'
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;






SELECT [CombinID], [CategoryID], [TID], [SID], category
from 
(
	 SELECT [CombinID], [CategoryID], 
		   PARSENAME(REPLACE([CategoryID],'-','.'),2) [TID], 
		   PARSENAME(REPLACE([CategoryID],'-','.'),1) [SID],
		   Category
	  FROM (SELECT [CombinID], [CategoryID] , CASE @LANG WHEN 'FR' THEN [Category_fr] ELSE [Category] END AS Category FROM [dbo].[Combine_Categories]) AS T1 
) AS T2

END
GO










IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resource_In_Radius_boundary_Box')
DROP PROCEDURE Proc_Search_Resource_In_Radius_boundary_Box
GO
CREATE PROCEDURE [dbo].[Proc_Search_Resource_In_Radius_boundary_Box]
@Lat NUMERIC(18,10) = 43.654490,
@Long NUMERIC(18,10) = -79.387419,
@Radius NUMERIC(18,10) = 5.0,
@lang Nvarchar(50) = N'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DECLARE @Distance NUMERIC(18,10) = @Radius * 1609.344  ;
	DECLARE @Earth_Radius INT = 6371000;


	DECLARE @NorthLat NUMERIC(18,10) = @Lat + DEGREES(@distance / @Earth_Radius)
   ,@SouthLat NUMERIC(18,10) = @Lat - DEGREES(@distance / @Earth_Radius)
   ,@EastLong NUMERIC(18,10) = @Long + DEGREES(@distance / @Earth_Radius / COS(RADIANS(@Lat)))
   ,@WestLong NUMERIC(18,10) = @Long - DEGREES(@distance / @Earth_Radius / COS(RADIANS(@Lat)));
    -- Insert statements for procedure here
SELECT       DISTINCT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, a.SubCategoryID
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, A.[PhysicalAddress]
				, A.[PhysicalAddressIsPrivate]
				, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
				, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
				, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
				, a.Latitude
				, a.Longitude
				, a.Phone
				, a.WebsiteAddress
FROM            RamResource AS a  
                    INNER JOIN       CityLocation AS c ON a.PhysicalCityID = c.CityId  
                    INNER JOIN       Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
                    INNER JOIN       ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
                    INNER JOIN       SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
                    INNER JOIN       TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID 
					-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 

WHERE (
            A.Latitude >= @SouthLat
            AND A.Latitude <= @NorthLat )
        AND (
              A.Longitude >= @WestLong
              AND A.Longitude <= @EastLong )
		AND a.PhysicalCityID != 0   AND SC.Active = 1 AND TC.Active = 1 
ORDER BY       a.TOPCategoryID,  a.SubCategoryID, a.Map 
              --a.PhysicalProvinceID, a.PhysicalCityID, 
END
GO













GO
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_All_Resource_In_Radius_boundary_Box')
DROP PROCEDURE Proc_Get_All_Resource_In_Radius_boundary_Box
GO
CREATE PROCEDURE [dbo].[Proc_Get_All_Resource_In_Radius_boundary_Box]
@Lat NUMERIC(18,10) = 43.654490,
@Long NUMERIC(18,10) = -79.387419,
@Radius NUMERIC(18,10) = 5.0,
@lang Nvarchar(50) = N'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DECLARE @Distance NUMERIC(18,10) = @Radius * 1609.344  ;
	DECLARE @Earth_Radius INT = 6371000;


	DECLARE @NorthLat NUMERIC(18,10) = @Lat + DEGREES(@distance / @Earth_Radius)
   ,@SouthLat NUMERIC(18,10) = @Lat - DEGREES(@distance / @Earth_Radius)
   ,@EastLong NUMERIC(18,10) = @Long + DEGREES(@distance / @Earth_Radius / COS(RADIANS(@Lat)))
   ,@WestLong NUMERIC(18,10) = @Long - DEGREES(@distance / @Earth_Radius / COS(RADIANS(@Lat)));
    -- Insert statements for procedure here
SELECT        DISTINCT
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime 
FROM            RamResource AS a  
                    INNER JOIN       CityLocation AS c ON a.PhysicalCityID = c.CityId  
                    INNER JOIN       Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
                    INNER JOIN       ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
                    INNER JOIN       SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
                    INNER JOIN       TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID 
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID -- Return only those resources whose PhysicalCityID is in the allowing City list

WHERE (
            A.Latitude >= @SouthLat
            AND A.Latitude <= @NorthLat )
        AND (
              A.Longitude >= @WestLong
              AND A.Longitude <= @EastLong )
		AND a.PhysicalCityID != 0   AND SC.Active = 1 AND TC.Active = 1 
ORDER BY       a.TOPCategoryID,  a.SubCategoryID, a.Map 
              --a.PhysicalProvinceID, a.PhysicalCityID, 
END
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_All_Resources_In_Radius')
DROP PROCEDURE Proc_Get_All_Resources_In_Radius
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_All_Resources_In_Radius')
DROP PROCEDURE Proc_Get_All_Resources_In_Radius
GO
CREATE PROCEDURE [dbo].[Proc_Get_All_Resources_In_Radius] 
	-- Add the parameters for the stored procedure here
@StartLatitude NUMERIC(18,10) = 43.654490,
@StartLongitude NUMERIC(18,10) = -79.387419,
@Radius NUMERIC(18,10) = 5.00 ,
@lang NVARCHAR(50) = N'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
 
SELECT		DISTINCT
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
                    INNER JOIN     CityLocation AS c ON a.PhysicalCityID = c.CityId  
                    INNER JOIN     Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
                    INNER JOIN     ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
                    INNER JOIN     SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
                    INNER JOIN     TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID 
				-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN  F_Get_Allow_TopCategory (@token) AS ATC 	ON ATC.TOPCategoryID = A.TOPCategoryID 
				-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN  F_Get_ALL_Allow_City (@token) AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE			[dbo].[fnCalcDistanceKM](@StartLatitude, @StartLongitude, a.Latitude, a.Longitude) < @Radius 
				AND a.PhysicalCityID != 0 AND SC.Active = 1  AND  TC.Active = 1
ORDER BY        a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID, 
END





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'fnCalcDistanceKM')
DROP PROCEDURE fnCalcDistanceKM
GO




--FN = Scalar Function
--IF = Inlined Table Function
--TF = Table Function

IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'fnCalcDistanceKM')
DROP FUNCTION fnCalcDistanceKM 
GO
CREATE FUNCTION [dbo].[fnCalcDistanceKM](
@lat1 NUMERIC(18,10), 
@lon1 NUMERIC(18,10),
@lat2 NUMERIC(18,10),  
@lon2 NUMERIC(18,10))
RETURNS NUMERIC(18,10) 
WITH ENCRYPTION
AS
BEGIN

    RETURN ACOS(SIN(PI()*@lat1/180.0)*SIN(PI()*@lat2/180.0)+COS(PI()*@lat1/180.0)*COS(PI()*@lat2/180.0)*COS(PI()*@lon2/180.0-PI()*@lon1/180.0))*6371
END
GO



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_All_RamResource')
DROP PROCEDURE Proc_Get_All_RamResource 
GO
CREATE PROCEDURE [dbo].[Proc_Get_All_RamResource]
@lang nvarchar (50) =N' ',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT    DISTINCT    
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
                    INNER JOIN     CityLocation AS c ON a.PhysicalCityID = c.CityId  
                    INNER JOIN     Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
                    INNER JOIN     ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
                    INNER JOIN     SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
                    INNER JOIN     TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID
								-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
								-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE					SC.Active = 1 AND TC.Active = 1
ORDER BY         a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID,
END
GO




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_All_RamResource_by_Lang')
DROP PROCEDURE Proc_Get_All_RamResource_by_Lang 
GO
CREATE PROCEDURE [dbo].[Proc_Get_All_RamResource_by_Lang]
 @lang nvarchar(20) = 'en',
 @token NVARCHAR (50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT	DISTINCT
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
						--a.changedDate, 
						--a.createdDate
FROM            RamResource AS a 
					INNER JOIN		CityLocation		AS c	ON a.PhysicalCityID = c.CityId  
					INNER JOIN		Province			AS p	ON a.PhysicalProvinceID = p.ProvinceID  
					INNER JOIN		ETLLoad				AS ETL	ON a.ETLLoadID = ETL.ETLLoadID  
					INNER JOIN		SubCategory			AS SC	ON SC.SubCategoryID = a.SubCategoryID  
					INNER JOIN		TopCategory			AS TC	ON TC.TopCategoryID = a.TOPCategoryID
					-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 

WHERE a.LanguageOfRecord = @lang  AND  SC.Active = 1 AND TC.Active = 1
ORDER BY        a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID, 
END
GO





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Increment_Suggestion_Word')
DROP PROCEDURE Proc_Increment_Suggestion_Word 
GO
CREATE PROCEDURE [dbo].[Proc_Increment_Suggestion_Word]
	-- Add the parameters for the stored procedure here
 @L NVARCHAR (255)
 WITH ENCRYPTION
AS
BEGIN
　
	SET NOCOUNT ON;

SELECT TOP(10)  [SuggestionWordID], [SuggestionWord]   
	FROM  [dbo].[SuggestionWord]    
	WHERE [SuggestionWord] LIKE ''+ @L+'%'


END
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Increment_Loaction_Search')
DROP PROCEDURE Proc_Increment_Loaction_Search
GO
CREATE PROCEDURE [dbo].[Proc_Increment_Loaction_Search]
	-- Add the parameters for the stored procedure here
@L nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT TOP (30) c.cityid, c.ProvinceID, c.[CityName]+ ', '+ p.ProvinceAlias AS Location  
FROM [dbo].[CityLocation] AS c join province AS p ON c.ProvinceID = p.ProvinceID
WHERE p.ProvinceID < 15 and c.[CityName] like ''+ @L+'%'
ORDER BY c.[CityName], p.ProvinceAlias


END
GO





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_SuggestionWord_List')
DROP PROCEDURE Proc_Get_SuggestionWord_List
GO
CREATE PROCEDURE [dbo].[Proc_Get_SuggestionWord_List] 
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT [SuggestionWordID]
      ,[SuggestionWord]

  FROM [RAM].[dbo].[SuggestionWord]
END
GO




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_TopCategory_Subcategory_Location_Search')
DROP PROCEDURE Proc_TopCategory_Subcategory_Location_Search
GO
CREATE PROCEDURE [dbo].[Proc_TopCategory_Subcategory_Location_Search]
	-- Add the parameters for the stored procedure here
@TOPCategoryID INT = 0 ,
@SubCategoryID INT = 0 ,
@CityID INT = 0 , 
@lang NVARCHAR(50) = 'en'
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

IF (@CityID = 0 ) 
	BEGIN
		IF (@TOPCategoryID = 0)  --- Get All Resources  任意category的 Resources 即全部数据
			BEGIN
			SELECT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, CASE c.CityName  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ c.CityName+', '+ p.[ProvinceAlias])	 END  AS PublicNames
				, a.AgencyDescription
				, PhysicalAddress 
				, [PhysicalCityID]
				, CASE c.CityName  	WHEN 'TBD' THEN '' ELSE c.CityName END AS [City]
				, [PhysicalProvinceID]
				, CASE p.[ProvinceAlias]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(ETL.[TaxonomyTerm],'/',' ')  AS STerm
				, REPLACE(ETL.TaxonomyTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.changedDate
				, a.createdDate 
				FROM            RamResource   AS a 
				JOIN [dbo].[CityLocation] AS c ON a.PhysicalCityID = c.CityId 
				JOIN [dbo].[Province] AS p ON a.PhysicalProvinceID = p.ProvinceID
				JOIN [dbo].[ETLLoad] AS ETL ON a.ETLLoadID = ETL.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC ON TC.TopCategoryID = A.TOPCategoryID
				WHERE a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
				ORDER BY  SC.[SubCategoryID]  
			END
		ELSE IF (@SubCategoryID = 0)  ---  Get All 具体TopCategoryID = @TopCategoryID 的 Resources
				BEGIN 
				SELECT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, CASE c.CityName  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ c.CityName+', '+ p.[ProvinceAlias])	 END  AS PublicNames
				, a.AgencyDescription
				, PhysicalAddress 
				, [PhysicalCityID]
				, CASE c.CityName  	WHEN 'TBD' THEN '' ELSE c.CityName END AS [City]
				, [PhysicalProvinceID]
				, CASE p.[ProvinceAlias]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(ETL.[TaxonomyTerm],'/',' ')  AS STerm
				, REPLACE(ETL.TaxonomyTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.changedDate
				, a.createdDate 
				FROM            RamResource   AS a 
				JOIN [dbo].[CityLocation] AS c ON a.PhysicalCityID = c.CityId 
				JOIN [dbo].[Province] AS p ON a.PhysicalProvinceID = p.ProvinceID
				JOIN [dbo].[ETLLoad] AS ETL ON a.ETLLoadID = ETL.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC ON TC.TopCategoryID = A.TOPCategoryID
				WHERE a.TOPCategoryID = @TOPCategoryID AND a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
				ORDER BY  SC.[SubCategoryID]  
				END
			ELSE  --- Get 具体 TopCategoryID = @TopCategoryID  并且  SubCategoryID = @SubCategoryID  的 Resources
				BEGIN
				SELECT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, CASE c.CityName  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ c.CityName+', '+ p.[ProvinceAlias])	 END  AS PublicNames
				, a.AgencyDescription
				, PhysicalAddress 
				, [PhysicalCityID]
				, CASE c.CityName  	WHEN 'TBD' THEN '' ELSE c.CityName END AS [City]
				, [PhysicalProvinceID]
				, CASE p.[ProvinceAlias]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(ETL.[TaxonomyTerm],'/',' ')  AS STerm
				, REPLACE(ETL.TaxonomyTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.changedDate
				, a.createdDate 
				FROM            RamResource   AS a 
				JOIN [dbo].[CityLocation] AS c ON a.PhysicalCityID = c.CityId 
				JOIN [dbo].[Province] AS p ON a.PhysicalProvinceID = p.ProvinceID
				JOIN [dbo].[ETLLoad] AS ETL ON a.ETLLoadID = ETL.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC ON TC.TopCategoryID = A.TOPCategoryID
				WHERE a.TOPCategoryID = @TOPCategoryID AND a.SubCategoryID = @SubCategoryID AND a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
				ORDER BY  SC.[SubCategoryID]  
				END
	END
ELSE
	BEGIN
			IF (@TOPCategoryID = 0)  --- Get All Resources  任意category的 Resources 即全部数据
			BEGIN
				SELECT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, CASE c.CityName  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ c.CityName+', '+ p.[ProvinceAlias])	 END  AS PublicNames
				, a.AgencyDescription
				, PhysicalAddress 
				, [PhysicalCityID]
				, CASE c.CityName  	WHEN 'TBD' THEN '' ELSE c.CityName END AS [City]
				, [PhysicalProvinceID]
				, CASE p.[ProvinceAlias]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(ETL.[TaxonomyTerm],'/',' ')  AS STerm
				, REPLACE(ETL.TaxonomyTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.changedDate
				, a.createdDate 
				FROM            RamResource   AS a 
				JOIN [dbo].[CityLocation] AS c ON a.PhysicalCityID = c.CityId 
				JOIN [dbo].[Province] AS p ON a.PhysicalProvinceID = p.ProvinceID
				JOIN [dbo].[ETLLoad] AS ETL ON a.ETLLoadID = ETL.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC ON TC.TopCategoryID = A.TOPCategoryID
				WHERE C.CityId = @CityID AND a.LanguageOfRecord = @lang  AND SC.Active = 1 AND TC.Active = 1 
				ORDER BY  SC.[SubCategoryID]  
			END
		ELSE IF (@SubCategoryID = 0)  ---  Get All 具体TopCategoryID = @TopCategoryID 的 Resources
				BEGIN 
				SELECT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, CASE c.CityName  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ c.CityName+', '+ p.[ProvinceAlias])	 END  AS PublicNames
				, a.AgencyDescription
				, PhysicalAddress 
				, [PhysicalCityID]
				, CASE c.CityName  	WHEN 'TBD' THEN '' ELSE c.CityName END AS [City]
				, [PhysicalProvinceID]
				, CASE p.[ProvinceAlias]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(ETL.[TaxonomyTerm],'/',' ')  AS STerm
				, REPLACE(ETL.TaxonomyTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.changedDate
				, a.createdDate 
				FROM            RamResource   AS a 
				JOIN [dbo].[CityLocation] AS c ON a.PhysicalCityID = c.CityId 
				JOIN [dbo].[Province] AS p ON a.PhysicalProvinceID = p.ProvinceID
				JOIN [dbo].[ETLLoad] AS ETL ON a.ETLLoadID = ETL.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC ON TC.TopCategoryID = A.TOPCategoryID
				WHERE a.TOPCategoryID = @TOPCategoryID AND C.CityId = @CityID AND a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
				ORDER BY  SC.[SubCategoryID]  
				END
			ELSE  --- Get 具体 TopCategoryID = @TopCategoryID  并且  SubCategoryID = @SubCategoryID  的 Resources
				BEGIN
				SELECT 
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, CASE c.CityName  	WHEN 'TBD' THEN a.publicname  ELSE CONVERT(NVARCHAR(2000),  '<p>' + a.publicname+'</p>'+ c.CityName+', '+ p.[ProvinceAlias])	 END  AS PublicNames
				, a.AgencyDescription
				, PhysicalAddress 
				, [PhysicalCityID]
				, CASE c.CityName  	WHEN 'TBD' THEN '' ELSE c.CityName END AS [City]
				, [PhysicalProvinceID]
				, CASE p.[ProvinceAlias]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS [Province]
				, a.PhysicalCountry   
				, a.PhysicalPostalCode
				, REPLACE(ETL.[TaxonomyTerm],'/',' ')  AS STerm
				, REPLACE(ETL.TaxonomyTerms,'/',' ')  AS LTerms
				, A.[PhysicalAddressIsPrivate]
				, a.Latitude
				, a.Longitude
				, a.HoursOfOperation
				, a.Phone
				, a.WebsiteAddress
				, a.Eligibility
				, a.DisabilitiesAccess
				, a.FeeStructureSource
				, a.ApplicationProcess
				, a.DocumentsRequired
				, a.LanguagesOfferedList
				, a.LanguageOfRecord
				, a.WorkHours
				, a.CustomEligibilitybyAge
				, a.changedDate
				, a.createdDate 
				FROM            RamResource   AS a 
				JOIN [dbo].[CityLocation] AS c ON a.PhysicalCityID = c.CityId 
				JOIN [dbo].[Province] AS p ON a.PhysicalProvinceID = p.ProvinceID
				JOIN [dbo].[ETLLoad] AS ETL ON a.ETLLoadID = ETL.ETLLoadID
				JOIN [dbo].[SubCategory] AS SC ON SC.[SubCategoryID] = A.SubCategoryID
				JOIN [dbo].[TopCategory] AS TC ON TC.TopCategoryID = A.TOPCategoryID
				WHERE a.TOPCategoryID = @TOPCategoryID AND a.SubCategoryID = @SubCategoryID AND C.CityId = @CityID AND a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
				ORDER BY  SC.[SubCategoryID]  
				END
	END

END

GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_TopCategory_by_ID')
DROP PROCEDURE Proc_TopCategory_by_ID
GO
CREATE PROCEDURE [dbo].[Proc_TopCategory_by_ID] 
	-- Add the parameters for the stored procedure here
@TID int,
@LANG NVARCHAR(20) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @v INT

	SELECT TOP(1) @v = TopcategoryID FROM F_Get_Allow_TopCategory (@token) 

    IF @V = 0
			BEGIN 
				SELECT TopCategoryID,
				CASE @LANG WHEN 'FR' THEN TopCategory_fr ELSE TopCategory END AS TopCategory
				FROM TopCategory WHERE TopCategoryID = @TID AND Active = 1
			END
		ELSE
			BEGIN
				SELECT TopCategoryID,
				CASE @LANG WHEN 'FR' THEN TopCategory_fr ELSE TopCategory END AS TopCategory
				FROM TopCategory WHERE TopCategoryID = @TID 
				AND Active = 1 
				AND TopCategoryID IN (SELECT * FROM F_Get_Allow_TopCategory (@token) )
			END
END
GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_TopCategory')
DROP PROCEDURE Proc_Get_TopCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_TopCategory]
  @lang nvarchar(50) ='en',
  @token nvarchar(50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @V INT
	SELECT Top(1) @v = TopcategoryID FROM F_Get_Allow_TopCategory (@token) 
 
	 IF @v=0  -- allows to access all TopCategory 
		begin
			SELECT TopCategoryID , 
					CASE @lang WHEN 'fr' THEN TopCategory_fr ELSE TopCategory END AS TopCategory 
					FROM [dbo].[TopCategory] WHERE Active = 1 
		end
	ELSE 
		begin
				SELECT TopCategoryID , 
				CASE @lang WHEN 'fr' THEN TopCategory_fr ELSE TopCategory END AS TopCategory 
				FROM [dbo].[TopCategory] WHERE Active = 1  
				AND TopCategoryID in (select * FROM F_Get_Allow_TopCategory (@token) )
		end
  
END
GO















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Building_Table_Keywords')
DROP PROCEDURE Proc_Building_Table_Keywords
GO
-- ==========================================================================================
-- Author:		William Chen
-- Create date: Aug.18, 2016
-- Description:	Building table "[RAM].[dbo].[keywords]"
--	there are some of important columns in the table of KEYWORDS
-- ==========================================================================================
CREATE PROCEDURE Proc_Building_Table_Keywords
	-- Add the parameters for the stored procedure here
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

		INSERT INTO keywords ([ETLLoadiD]
					, [PublicName]
					, [AgencyDescription]
					, [PhysicalAddress] 
					, [PhysicalCity] 
					, [PhysicalProvince]
					, [TaxonomyTerm]
					, [TaxonomyTerms]
					, [TopCategory]
					, [TopCategory_fr]
					, [SubCategory]
					, [SubCategory_fr]
					, [Coverage])
		SELECT   DISTINCT  
					r.etlloadid 
					, r.publicname  
					, r.[AgencyDescription] 
					, r.PhysicalAddress 
					, c.[CityName]  
					, p.ProvinceAlias 
					, e.TaxonomyTerm 
					, e.TaxonomyTerms 
					, TC.TopCategory
					, TC.TopCategory_fr
					, SC.SubCategory
					, SC.SubCategory_fr
					, R.[Coverage]
			FROM [dbo].[RamResource] R 
					JOIN [dbo].[TopCategory] AS TC ON R.TOPCategoryID = TC.TopCategoryID
					JOIN [dbo].[SubCategory] AS SC ON R.SubCategoryID = SC.SubCategoryID
					JOIN [dbo].[CityLocation] AS c ON r.PhysicalCityID = c.CityId 
					JOIN Province AS p ON r.PhysicalProvinceID = p.ProvinceID
					JOIN [dbo].[ETLLoad] AS e ON r.ETLLoadID = e.ETLLoadID 
			WHERE TC.Active =1 AND SC.Active =1
			ORDER by r.publicname
		;



		UPDATE keywords SET
				publicname = REPLACE(publicname,'/',' ')
				,[AgencyDescription] = REPLACE([AgencyDescription],'/',' ')
				,[TaxonomyTerm] = REPLACE([TaxonomyTerm],'/',' ')
				,[TaxonomyTerms] = REPLACE([TaxonomyTerms],'/',' ')
				,[TopCategory] = REPLACE ([TopCategory],'&',' ')
				,[TopCategory_fr] = REPLACE ([TopCategory_fr],'&',' ')
				,[SubCategory] = REPLACE([SubCategory],'&',' ')
				,[SubCategory_fr] = REPLACE([SubCategory_fr],'&',' ')
		;
END
GO






















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Location')
DROP PROCEDURE Proc_Get_Location
GO
CREATE PROCEDURE [dbo].[Proc_Get_Location]
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT [CityId] , [CityName] + ', ' + P.ProvinceAlias AS LOCATION  FROM [dbo].[CityLocation] AS C 
JOIN [dbo].[Province] AS P ON C.ProvinceID = P.ProvinceID
WHERE C.CityName !='TBD'
ORDER BY [CityName], LOCATION

END
GO




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_SubCategory_byTopCategory')
DROP PROCEDURE Proc_Get_SubCategory_byTopCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_SubCategory_byTopCategory]
	-- Add the parameters for the stored procedure here
@TID INT = 0,
@lang NVARCHAR (50) = 'en' ,
@token NVARCHAR (50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @v int
	SELECT TOP(1) @v = TopcategoryID FROM F_Get_Allow_TopCategory (@token) 

    IF @v = 0
		BEGIN  --  ALLOW TO ACCESS ALL TOPCATEGORY
				IF (@TID = 0) -- get all subcategory 
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
							WHERE S.Active =1  
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc]  FROM SubCategory   AS S
							WHERE S.Active =1  
						;
					END
				ELSE  -- get subCategory under specific TopCategory ID
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  WHERE [TopCategoryID] = @TID  AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1   
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  WHERE [TopCategoryID] = @TID AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1   
						;
					END
		END
	ELSE  --  ALLOW TO ACCESS specific TOPCATEGORY based on Access Control List
		BEGIN
				IF (@TID = 0)  -- get all allow subcategory 
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
							RIGHT JOIN [TopCategoryID_SubCategoryID] as TS0 on TS0.SubCategoryID = S.SubCategoryID 
							WHERE TS0.TopCategoryID in  ( SELECT * FROM F_Get_Allow_TopCategory (@token) )  AND S.Active =  1  AND TS0.Active = 1 
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc]  FROM SubCategory   AS S
							RIGHT JOIN [TopCategoryID_SubCategoryID] as TS0 on TS0.SubCategoryID = S.SubCategoryID 
							WHERE TS0.TopCategoryID in  ( SELECT * FROM F_Get_Allow_TopCategory (@token) )  AND S.Active =  1  AND TS0.Active = 1 
						;
					END
				ELSE  -- get subCategory under specific TopCategory ID
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  
									        WHERE [TopCategoryID] = @TID  AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1      AND   TS.TopCategoryID  IN (SELECT * FROM F_Get_Allow_TopCategory (@token))
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  
									        WHERE [TopCategoryID] = @TID AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1      AND   TS.TopCategoryID  IN (SELECT * FROM F_Get_Allow_TopCategory (@token))
						;
					END
		END


END

GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_SubCategory_by_SId')
DROP PROCEDURE Proc_Get_SubCategory_by_SId
GO
CREATE PROCEDURE [dbo].[Proc_Get_SubCategory_by_SId]
@SID INT,
 @lang nvarchar(50) ='en',
 @token NVARCHAR (50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @v int
	SELECT TOP(1) @v = TopcategoryID FROM F_Get_Allow_TopCategory (@token) 
 
	IF @v = 0 -- Allow access all topcategory
			BEGIN
				SELECT S.SubCategoryID , 
				CASE @LANG WHEN 'fr' THEN S.SubCategory_fr  ELSE S.SubCategory END AS SubCategory ,
				CASE @LANG WHEN 'fr' THEN S.[SubCategoryDesc_fr] ELSE  S.[SubCategoryDesc] END AS [SubCategoryDesc] 
				FROM [dbo].[SubCategory] AS S WHERE S.SubCategoryID = @SID and S.Active = 1  
			END
		ELSE
			BEGIN
				SELECT S.SubCategoryID , 
				CASE @LANG WHEN 'fr' THEN S.SubCategory_fr  ELSE S.SubCategory END AS SubCategory ,
				CASE @LANG WHEN 'fr' THEN S.[SubCategoryDesc_fr] ELSE  S.[SubCategoryDesc] END AS [SubCategoryDesc] 
				FROM [dbo].[SubCategory] AS S JOIN [TopCategoryID_SubCategoryID] as ts on s.SubCategoryID = ts.SubCategoryID
				WHERE S.SubCategoryID = @SID 
				AND TS.TopCategoryID IN (SELECT * FROM F_Get_Allow_TopCategory (@token) )
				AND S.Active = 1 
			END

END
GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_SubCategory')
DROP PROCEDURE Proc_Get_SubCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_SubCategory]
 @lang nvarchar(50) ='en',
 @token NVARCHAR(50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @v int;
	SELECT TOP(1) @v = TopcategoryID FROM F_Get_Allow_TopCategory (@token);

	IF @v = 0  -- Allow access all topcategory
		BEGIN 
			SELECT s.SubCategoryID , 
			CASE @LANG WHEN 'fr' THEN s.SubCategory_fr  ELSE s.SubCategory END AS SubCategory ,
			CASE @LANG WHEN 'fr' THEN s.[SubCategoryDesc_fr] ELSE  s.[SubCategoryDesc] END AS [SubCategoryDesc] 
			FROM [dbo].[SubCategory] as s WHERE s.Active = 1  
			ORDER BY s.SubCategoryID
		END
	ELSE    -- BASE ON allowing topcategory , list out subcategory 
		BEGIN
			SELECT s.SubCategoryID , 
			CASE @LANG WHEN 'fr' THEN s.SubCategory_fr  ELSE s.SubCategory END AS SubCategory ,
			CASE @LANG WHEN 'fr' THEN s.[SubCategoryDesc_fr] ELSE  s.[SubCategoryDesc] END AS [SubCategoryDesc] 
			FROM [dbo].[SubCategory] as s JOIN [TopCategoryID_SubCategoryID] as ts on s.SubCategoryID = ts.SubCategoryID
			WHERE s.Active = 1  AND TS.TopCategoryID IN (SELECT * FROM F_Get_Allow_TopCategory (@token) )
			ORDER BY s.SubCategoryID
		END

END
GO




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_SubCategory_byTopCategory')
DROP PROCEDURE Proc_Get_SubCategory_byTopCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_SubCategory_byTopCategory]
	-- Add the parameters for the stored procedure here
@TID INT = 0,
@lang NVARCHAR (50) = 'en' ,
@token NVARCHAR (50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @v int
	SELECT TOP(1) @v = TopcategoryID FROM F_Get_Allow_TopCategory (@token) 

    IF @v = 0
		BEGIN  --  ALLOW TO ACCESS ALL TOPCATEGORY
				IF (@TID = 0) -- get all subcategory 
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
							WHERE S.Active =1  
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc]  FROM SubCategory   AS S
							WHERE S.Active =1  
						;
					END
				ELSE  -- get subCategory under specific TopCategory ID
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  WHERE [TopCategoryID] = @TID  AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1   
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  WHERE [TopCategoryID] = @TID AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1   
						;
					END
		END
	ELSE  --  ALLOW TO ACCESS specific TOPCATEGORY based on Access Control List
		BEGIN
				IF (@TID = 0)  -- get all allow subcategory 
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
							RIGHT JOIN [TopCategoryID_SubCategoryID] as TS0 on TS0.SubCategoryID = S.SubCategoryID 
							WHERE TS0.TopCategoryID in  ( SELECT * FROM F_Get_Allow_TopCategory (@token) )  AND S.Active =  1  AND TS0.Active = 1 
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc]  FROM SubCategory   AS S
							RIGHT JOIN [TopCategoryID_SubCategoryID] as TS0 on TS0.SubCategoryID = S.SubCategoryID 
							WHERE TS0.TopCategoryID in  ( SELECT * FROM F_Get_Allow_TopCategory (@token) )  AND S.Active =  1  AND TS0.Active = 1 
						;
					END
				ELSE  -- get subCategory under specific TopCategory ID
					BEGIN
						IF (@lang = 'fr')
							SELECT S.SubCategoryID,  S.SubCategory_fr AS SubCategory , [SubCategoryDesc_fr] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  
									        WHERE [TopCategoryID] = @TID  AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1      AND   TS.TopCategoryID  IN (SELECT * FROM F_Get_Allow_TopCategory (@token))
						ELSE
							SELECT S.SubCategoryID, S.SubCategory AS SubCategory , [SubCategoryDesc] AS [SubCategoryDesc] FROM SubCategory   AS S
									JOIN   (SELECT [TopCategoryID], SubCategoryID FROM [TopCategoryID_SubCategoryID]  
									        WHERE [TopCategoryID] = @TID AND [TopCategoryID_SubCategoryID].Active = 1) AS TS 
											ON S.SubCategoryID = TS.SubCategoryID
							WHERE S.Active =1      AND   TS.TopCategoryID  IN (SELECT * FROM F_Get_Allow_TopCategory (@token))
						;
					END
		END


END
GO



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_City')
DROP PROCEDURE Proc_Get_Resource_by_City
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_City] 
@CityID int,
@lang nvarchar(50) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;



SELECT		DISTINCT
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime 
FROM            RamResource AS a 
					INNER JOIN       CityLocation AS c	ON a.PhysicalCityID = c.CityId  
					INNER JOIN       Province AS p		ON a.PhysicalProvinceID = p.ProvinceID  
					INNER JOIN       ETLLoad AS ETL		ON a.ETLLoadID = ETL.ETLLoadID  
					INNER JOIN       SubCategory AS SC	ON SC.SubCategoryID = a.SubCategoryID 
					INNER JOIN       TopCategory AS TC	ON TC.TopCategoryID = a.TOPCategoryID
				  	-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE [PhysicalCityID] = @CityID and a.LanguageOfRecord  = @lang  AND SC.Active = 1  AND TC.Active = 1
ORDER BY  a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID,
END
GO



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_ID')
DROP PROCEDURE Proc_Get_Resource_by_ID
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_ID] 
@id INT,
@lang NVARCHAR(20) = 'EN',
@token NVARCHAR (50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT    DISTINCT    
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
					INNER JOIN      CityLocation AS c ON a.PhysicalCityID = c.CityId  
					INNER JOIN      Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
					INNER JOIN      ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
					INNER JOIN      SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
					INNER JOIN      TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID
				   	-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE       a.LanguageOfRecord = @lang   AND (a.ETLLoadID = @id)  AND SC.Active = 1 AND TC.Active = 1 

END


GO



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Get_City_By_CId')
DROP PROCEDURE Get_City_By_CId
GO
CREATE PROCEDURE [dbo].[Get_City_By_CId]
	-- Add the parameters for the stored procedure here
	@cid int,
	@token NVARCHAR(50)
	WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        CityId, CityName as city, province.ProvinceAlias as province, CityLocation.latitude, CityLocation.longitude
FROM            CityLocation  join province on CityLocation.ProvinceID = province.ProvinceID
WHERE CityLocation.CityId = @cid and CityName !='TBD'  AND CityId IN (SELECT CityId FROM F_Get_ALL_Allow_City(@token))
ORDER BY CityName, CityId
END
GO




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'GetCityAll')
DROP PROCEDURE GetCityAll
GO
CREATE PROCEDURE [dbo].[GetCityAll] 
	-- Add the parameters for the stored procedure here
		@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SET NOCOUNT ON;
	DECLARE @V INT

    -- Insert statements for procedure here
SELECT        CityId, CityName as city,   p.ProvinceAlias as Province
FROM            CityLocation as c  JOIN Province as p on  c.ProvinceID = p.ProvinceID
WHERE Cityname != 'TBD' AND CityID IN (select * from F_Get_ALL_Allow_City(@token))
ORDER BY c.ProvinceID, Cityname 
END
GO





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'GetCityByProvince')
DROP PROCEDURE GetCityByProvince
GO
CREATE PROCEDURE [dbo].[GetCityByProvince]
	-- Add the parameters for the stored procedure here
	@pid int,
	@token NVARCHAR(50)
	WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        CityId, CityName as city, province.ProvinceAlias as province
FROM            CityLocation  join province on CityLocation.ProvinceID = province.ProvinceID
WHERE province.[ProvinceID] = @pid and CityName !='TBD'
		 AND CityId IN (SELECT * FROM F_Get_ALL_Allow_City(@token))
ORDER BY CityLocation.ProvinceID, CityName  
END
GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getProvince')
DROP PROCEDURE getProvince
GO
CREATE PROCEDURE [dbo].[getProvince]
 @lang nvarchar(10) = N'en',
 @token nvarchar(50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @V INT
	SELECT TOP(1) @v = ProvinceID FROM F_Get_Allow_Province (@token) 

	IF @v = 0  -- allow access all of province
		BEGIN
			IF @lang = 'en'
				SELECT        ProvinceID, [ProvinceAlias] as Alias, Province as Province
				FROM            Province
				WHERE        (ProvinceID < 20)

			else
				SELECT        ProvinceID, [ProvinceAlias] as Alias, [ProvinceFrench] as Province
				FROM            Province
				WHERE        (ProvinceID < 20)
		END
	ELSE
		BEGIN  -- allow access sepcific province based on the access control List table 
			IF @lang = 'en'
				SELECT        ProvinceID, [ProvinceAlias] as Alias, Province as Province
				FROM            Province
				WHERE        (ProvinceID < 20) AND ProvinceID IN (SELECT  ProvinceID FROM F_Get_Allow_Province (@token) )

			else
				SELECT        ProvinceID, [ProvinceAlias] as Alias, [ProvinceFrench] as Province
				FROM            Province
				WHERE        (ProvinceID < 20) AND ProvinceID IN (SELECT  ProvinceID FROM F_Get_Allow_Province (@token) )
		END
	
	
END
GO










IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Unique_Resource')
DROP PROCEDURE Proc_Get_Unique_Resource
GO
CREATE PROCEDURE Proc_Get_Unique_Resource 
 @map nvarchar(50) = N'mapped',
 @resourceAgencyNum nvarchar(50) = N'12087761',
 @subcategoryid int  = 5,
 @topcategoryid int  = 2,
 @lang nvarchar(50)  =N'en',
 @token NVARCHAR (50)
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT      DISTINCT  
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
					INNER JOIN      CityLocation AS c	ON a.PhysicalCityID = c.CityId  
					INNER JOIN      Province AS p		ON a.PhysicalProvinceID = p.ProvinceID  
					INNER JOIN      ETLLoad AS ETL		ON a.ETLLoadID = ETL.ETLLoadID  
					INNER JOIN      SubCategory AS SC	ON SC.SubCategoryID = a.SubCategoryID  
					INNER JOIN      TopCategory AS TC	ON TC.TopCategoryID = a.TOPCategoryID
				   	-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE       
		[map] = @map and 
		a.[ResourceAgencyNum] =@resourceAgencyNum  and 
		a.[SubCategoryID] =@subcategoryid and
		a.[TOPCategoryID] = @topcategoryid  and
		a.[LanguageOfRecord] = @lang  AND SC.Active = 1 AND TC.Active = 1 
END
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_Province')
DROP PROCEDURE Proc_Get_Resource_by_Province
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_Province] 
@ProvinceID int,
@lang nvarchar(50) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT     DISTINCT   
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
                   INNER JOIN      CityLocation AS c	ON a.PhysicalCityID = c.CityId  
                   INNER JOIN      Province AS p		ON a.PhysicalProvinceID = p.ProvinceID  
                   INNER JOIN      ETLLoad AS ETL		ON a.ETLLoadID = ETL.ETLLoadID  
                   INNER JOIN      SubCategory AS SC	ON SC.SubCategoryID = a.SubCategoryID  
                   INNER JOIN      TopCategory AS TC	ON TC.TopCategoryID = a.TOPCategoryID
				   -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE [PhysicalProvinceID] = @ProvinceID  and a.LanguageOfRecord = @lang    AND SC.Active = 1 AND TC.Active = 1 
ORDER BY        a.TOPCategoryID,  a.SubCategoryID, a.Map
-- a.PhysicalProvinceID, a.PhysicalCityID,
END
GO






-- =============================================================
-- Author:		William Chen
-- Create date: Oct.20, 2015
-- Description:	get resource by using Top Province_and_City
-- Revision: Feb.10, 2016
-- Nov.14, 2016
--				this SP seems no longer use 
-- =============================================================
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_Province_and_City')
DROP PROCEDURE Proc_Get_Resource_by_Province_and_City
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_Province_and_City] 
@CityID int,
@ProvinceID int,
@lang nvarchar(50) = 'en'
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

 

SELECT        
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a INNER JOIN
                         CityLocation AS c ON a.PhysicalCityID = c.CityId INNER JOIN
                         Province AS p ON a.PhysicalProvinceID = p.ProvinceID INNER JOIN
                         ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID INNER JOIN
                         SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID INNER JOIN
                         TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID
WHERE [PhysicalProvinceID] = @ProvinceID AND [PhysicalCityID] = @CityID AND a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
ORDER BY        a.PhysicalProvinceID, a.PhysicalCityID, a.TOPCategoryID,  a.SubCategoryID, a.Map
END
GO








IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'GetMajorVersion')
DROP PROCEDURE GetMajorVersion
GO
CREATE PROCEDURE [dbo].[GetMajorVersion]
    @@ver int OUTPUT
	WITH ENCRYPTION
AS
BEGIN
	DECLARE @version        nchar(100)
	DECLARE @dot            int
	DECLARE @hyphen         int
	DECLARE @SqlToExec      nchar(4000)

	SELECT @@ver = 7
	SELECT @version = @@Version
	SELECT @hyphen  = CHARINDEX(N' - ', @version)
	IF (NOT(@hyphen IS NULL) AND @hyphen > 0)
	BEGIN
		SELECT @hyphen = @hyphen + 3
		SELECT @dot    = CHARINDEX(N'.', @version, @hyphen)
		IF (NOT(@dot IS NULL) AND @dot > @hyphen)
		BEGIN
			SELECT @version = SUBSTRING(@version, @hyphen, @dot - @hyphen)
			SELECT @@ver     = CONVERT(int, @version)
		END
	END
END
GO








IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'GetHashCode')
DROP PROCEDURE GetHashCode
GO
CREATE PROCEDURE [dbo].[GetHashCode]
    @input tAppName,
    @hash int OUTPUT
	WITH ENCRYPTION
AS
    /* 
       This sproc is based on this C# hash function:

        int GetHashCode(string s)
        {
            int     hash = 5381;
            int     len = s.Length;

            for (int i = 0; i < len; i++) {
                int     c = Convert.ToInt32(s[i]);
                hash = ((hash << 5) + hash) ^ c;
            }

            return hash;
        }

        However, SQL 7 doesn't provide a 32-bit integer
        type that allows rollover of bits, we have to
        divide our 32bit integer into the upper and lower
        16 bits to do our calculation.
    */
       
    DECLARE @hi_16bit   int
    DECLARE @lo_16bit   int
    DECLARE @hi_t       int
    DECLARE @lo_t       int
    DECLARE @len        int
    DECLARE @i          int
    DECLARE @c          int
    DECLARE @carry      int

    SET @hi_16bit = 0
    SET @lo_16bit = 5381
    
    SET @len = DATALENGTH(@input)
    SET @i = 1
    
    WHILE (@i <= @len)
    BEGIN
        SET @c = ASCII(SUBSTRING(@input, @i, 1))

        /* Formula:                        
           hash = ((hash << 5) + hash) ^ c */

        /* hash << 5 */
        SET @hi_t = @hi_16bit * 32 /* high 16bits << 5 */
        SET @hi_t = @hi_t & 0xFFFF /* zero out overflow */
        
        SET @lo_t = @lo_16bit * 32 /* low 16bits << 5 */
        
        SET @carry = @lo_16bit & 0x1F0000 /* move low 16bits carryover to hi 16bits */
        SET @carry = @carry / 0x10000 /* >> 16 */
        SET @hi_t = @hi_t + @carry
        SET @hi_t = @hi_t & 0xFFFF /* zero out overflow */

        /* + hash */
        SET @lo_16bit = @lo_16bit + @lo_t
        SET @hi_16bit = @hi_16bit + @hi_t + (@lo_16bit / 0x10000)
        /* delay clearing the overflow */

        /* ^c */
        SET @lo_16bit = @lo_16bit ^ @c

        /* Now clear the overflow bits */	
        SET @hi_16bit = @hi_16bit & 0xFFFF
        SET @lo_16bit = @lo_16bit & 0xFFFF

        SET @i = @i + 1
    END

    /* Do a sign extension of the hi-16bit if needed */
    IF (@hi_16bit & 0x8000 <> 0)
        SET @hi_16bit = 0xFFFF0000 | @hi_16bit

    /* Merge hi and lo 16bit back together */
    SET @hi_16bit = @hi_16bit * 0x10000 /* << 16 */
    SET @hash = @hi_16bit | @lo_16bit

    RETURN 0
GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getProvinceByID')
DROP PROCEDURE getProvinceByID
GO
CREATE PROCEDURE [dbo].[getProvinceByID] 
	-- Add the parameters for the stored procedure here
@lang nvarchar(50) = N'en',
@pid int = 1,
@token NVARCHAR (50)
WITH ENCRYPTION
AS

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @v INT
	SELECT TOP(1) @v = ProvinceID FROM F_Get_Allow_Province (@token) 
	IF @v = 0 
		BEGIN -- Allow list out any province
			if @lang = 'en'
				SELECT        ProvinceID, [ProvinceAlias] as Alias, Province as Province
				FROM            Province
				WHERE        (ProvinceID =@pid)
			else
				SELECT        ProvinceID, [ProvinceAlias] as Alias, [ProvinceFrench] as Province
				FROM            Province
				WHERE        (ProvinceID =@pid)
		END
	ELSE
		BEGIN  -- Allow list specific Province based on access control list in table permission
			if @lang = 'en'
				SELECT        ProvinceID, [ProvinceAlias] as Alias, Province as Province
				FROM            Province
				WHERE         ProvinceID =@pid  AND  @pid IN (SELECT  ProvinceID FROM F_Get_Allow_Province (@token) )
			else
				SELECT        ProvinceID, [ProvinceAlias] as Alias, [ProvinceFrench] as Province
				FROM            Province
				WHERE         ProvinceID =@pid  AND  @pid IN (SELECT  ProvinceID FROM F_Get_Allow_Province (@token) )
		END

END
GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_SubCategory')
DROP PROCEDURE Proc_Get_Resource_by_SubCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_SubCategory] 
@SubCategoryID int,
@lang nvarchar(50) ='en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT     DISTINCT  
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
					INNER JOIN      CityLocation AS c		ON a.PhysicalCityID = c.CityId  
					INNER JOIN      Province AS p			ON a.PhysicalProvinceID = p.ProvinceID  
					INNER JOIN      ETLLoad AS ETL			ON a.ETLLoadID = ETL.ETLLoadID  
					INNER JOIN      SubCategory AS SC		ON SC.SubCategoryID = a.SubCategoryID  
					INNER JOIN      TopCategory AS TC		ON TC.TopCategoryID = a.TOPCategoryID
				   -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE a.SubCategoryID = @SubCategoryID and a.LanguageOfRecord = @lang    AND SC.Active = 1 AND TC.Active = 1 
ORDER BY        a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID, 
END

GO







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_TopCategory')
DROP PROCEDURE Proc_Get_Resource_by_TopCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_TopCategory] 
@TOPCategoryID int,
@lang nvarchar(50) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT      DISTINCT 
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a 
					INNER JOIN      CityLocation AS c	ON a.PhysicalCityID = c.CityId  
					INNER JOIN      Province AS p		ON a.PhysicalProvinceID = p.ProvinceID  
					INNER JOIN      ETLLoad AS ETL		ON a.ETLLoadID = ETL.ETLLoadID  
					INNER JOIN      SubCategory AS SC	ON SC.SubCategoryID = a.SubCategoryID  
					INNER JOIN      TopCategory AS TC	ON TC.TopCategoryID = a.TOPCategoryID
				   	-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE a.TOPCategoryID = @TOPCategoryID  and a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
ORDER BY        a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID, 
END
GO






-- =====================================================
-- Author:		William Chen
-- Create date: Oct.20, 2015
-- Description:	get resource by using Top Category
-- Nov.14, 2016: This SP seems no longer use
-- 
-- ===================================================
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_by_Top_and_SubCategory')
DROP PROCEDURE Proc_Get_Resource_by_Top_and_SubCategory
GO
CREATE PROCEDURE [dbo].[Proc_Get_Resource_by_Top_and_SubCategory] 
@TOPCategoryID int,
@SubCategoryID int,
@lang nvarchar(50) = 'en'
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
 
SELECT        
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime
FROM            RamResource AS a INNER JOIN
                         CityLocation AS c ON a.PhysicalCityID = c.CityId INNER JOIN
                         Province AS p ON a.PhysicalProvinceID = p.ProvinceID INNER JOIN
                         ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID INNER JOIN
                         SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID INNER JOIN
                         TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID
WHERE a.TOPCategoryID = @TOPCategoryID AND a.SubCategoryID = @SubCategoryID AND a.LanguageOfRecord = @lang  AND SC.Active = 1 AND TC.Active = 1 
ORDER BY        a.PhysicalProvinceID, a.PhysicalCityID, a.TOPCategoryID,  a.SubCategoryID, a.Map
END

GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getCategories')
DROP PROCEDURE getCategories
GO
CREATE PROCEDURE [dbo].[getCategories] 
	-- Add the parameters for the stored procedure here
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        KHPCategoryID, KHPCategory, ImageSrc
FROM            KHPCategory
WHERE        (KHPCategoryID < 100)
END
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'getCategoriesFR')
DROP PROCEDURE getCategoriesFR
GO
CREATE PROCEDURE [dbo].[getCategoriesFR] 
	-- Add the parameters for the stored procedure here
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        KHPCategoryID, KHPCategoryFr, ImageSrc
FROM            KHPCategory
WHERE        (KHPCategoryID < 100)
END
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'DeleteExpiredSessions')
DROP PROCEDURE DeleteExpiredSessions
GO
        CREATE PROCEDURE [dbo].[DeleteExpiredSessions]
		WITH ENCRYPTION
        AS
            SET NOCOUNT ON
            SET DEADLOCK_PRIORITY LOW 

            DECLARE @now datetime
            SET @now = GETUTCDATE() 

            CREATE TABLE #tblExpiredSessions 
            ( 
                SessionId nvarchar(88) NOT NULL PRIMARY KEY
            )

            INSERT #tblExpiredSessions (SessionId)
                SELECT SessionId
                FROM [dbo].ASPStateTempSessions WITH (READUNCOMMITTED)
                WHERE Expires < @now

            IF @@ROWCOUNT <> 0 
            BEGIN 
                DECLARE ExpiredSessionCursor CURSOR LOCAL FORWARD_ONLY READ_ONLY
                FOR SELECT SessionId FROM #tblExpiredSessions 

                DECLARE @SessionId nvarchar(88)

                OPEN ExpiredSessionCursor

                FETCH NEXT FROM ExpiredSessionCursor INTO @SessionId

                WHILE @@FETCH_STATUS = 0 
                    BEGIN
                        DELETE FROM [dbo].ASPStateTempSessions WHERE SessionId = @SessionId AND Expires < @now
                        FETCH NEXT FROM ExpiredSessionCursor INTO @SessionId
                    END

                CLOSE ExpiredSessionCursor

                DEALLOCATE ExpiredSessionCursor

            END 

            DROP TABLE #tblExpiredSessions

        RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'CreateTempTables')
DROP PROCEDURE CreateTempTables
GO
        CREATE PROCEDURE [dbo].[CreateTempTables]
		WITH ENCRYPTION
        AS
            CREATE TABLE [dbo].ASPStateTempSessions (
                SessionId           nvarchar(88)    NOT NULL PRIMARY KEY,
                Created             datetime        NOT NULL DEFAULT GETUTCDATE(),
                Expires             datetime        NOT NULL,
                LockDate            datetime        NOT NULL,
                LockDateLocal       datetime        NOT NULL,
                LockCookie          int             NOT NULL,
                Timeout             int             NOT NULL,
                Locked              bit             NOT NULL,
                SessionItemShort    VARBINARY(7000) NULL,
                SessionItemLong     image           NULL,
                Flags               int             NOT NULL DEFAULT 0,
            ) 

            CREATE NONCLUSTERED INDEX Index_Expires ON [dbo].ASPStateTempSessions(Expires)

            CREATE TABLE [dbo].ASPStateTempApplications (
                AppId               int             NOT NULL PRIMARY KEY,
                AppName             char(280)       NOT NULL,
            ) 

            CREATE NONCLUSTERED INDEX Index_AppName ON [dbo].ASPStateTempApplications(AppName)

            RETURN 0  
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetAppID')
DROP PROCEDURE TempGetAppID
GO
    CREATE  PROCEDURE [dbo].[TempGetAppID]
    @appName    tAppName,
    @appId      int OUTPUT
	WITH ENCRYPTION
    AS
    SET @appName = LOWER(@appName)
    SET @appId = NULL

    SELECT @appId = AppId
    FROM [RAM].dbo.ASPStateTempApplications
    WHERE AppName = @appName

    IF @appId IS NULL BEGIN
        BEGIN TRAN        

        SELECT @appId = AppId
        FROM [RAM].dbo.ASPStateTempApplications WITH (TABLOCKX)
        WHERE AppName = @appName
        
        IF @appId IS NULL
        BEGIN
            EXEC GetHashCode @appName, @appId OUTPUT
            
            INSERT [RAM].dbo.ASPStateTempApplications
            VALUES
            (@appId, @appName)
            
            IF @@ERROR = 2627 
            BEGIN
                DECLARE @dupApp tAppName
            
                SELECT @dupApp = RTRIM(AppName)
                FROM [RAM].dbo.ASPStateTempApplications 
                WHERE AppId = @appId
                
                RAISERROR('SQL session state fatal error: hash-code collision between applications ''%s'' and ''%s''. Please rename the 1st application to resolve the problem.', 
                            18, 1, @appName, @dupApp)
            END
        END

        COMMIT
    END

    RETURN 0      
GO	   





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItem')
DROP PROCEDURE TempGetStateItem
GO
        CREATE PROCEDURE [dbo].[TempGetStateItem]
            @id         tSessionId,
            @itemShort  tSessionItemShort OUTPUT,
            @locked     bit OUTPUT,
            @lockDate   datetime OUTPUT,
            @lockCookie int OUTPUT
			WITH ENCRYPTION
        AS
            DECLARE @textptr AS tTextPtr
            DECLARE @length AS int
            DECLARE @now AS datetime
            SET @now = GETUTCDATE()

            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, @now), 
                @locked = Locked,
                @lockDate = LockDateLocal,
                @lockCookie = LockCookie,
                @itemShort = CASE @locked
                    WHEN 0 THEN SessionItemShort
                    ELSE NULL
                    END,
                @textptr = CASE @locked
                    WHEN 0 THEN TEXTPTR(SessionItemLong)
                    ELSE NULL
                    END,
                @length = CASE @locked
                    WHEN 0 THEN DATALENGTH(SessionItemLong)
                    ELSE NULL
                    END
            WHERE SessionId = @id
            IF @length IS NOT NULL BEGIN
                READTEXT [RAM].dbo.ASPStateTempSessions.SessionItemLong @textptr 0 @length
            END

            RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
GO





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItem2')
DROP PROCEDURE TempGetStateItem2	
go
        CREATE PROCEDURE [dbo].[TempGetStateItem2]
            @id         tSessionId,
            @itemShort  tSessionItemShort OUTPUT,
            @locked     bit OUTPUT,
            @lockAge    int OUTPUT,
            @lockCookie int OUTPUT
			WITH ENCRYPTION
        AS
            DECLARE @textptr AS tTextPtr
            DECLARE @length AS int
            DECLARE @now AS datetime
            SET @now = GETUTCDATE()

            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, @now), 
                @locked = Locked,
                @lockAge = DATEDIFF(second, LockDate, @now),
                @lockCookie = LockCookie,
                @itemShort = CASE @locked
                    WHEN 0 THEN SessionItemShort
                    ELSE NULL
                    END,
                @textptr = CASE @locked
                    WHEN 0 THEN TEXTPTR(SessionItemLong)
                    ELSE NULL
                    END,
                @length = CASE @locked
                    WHEN 0 THEN DATALENGTH(SessionItemLong)
                    ELSE NULL
                    END
            WHERE SessionId = @id
            IF @length IS NOT NULL BEGIN
                READTEXT [RAM].dbo.ASPStateTempSessions.SessionItemLong @textptr 0 @length
            END

            RETURN 0   
			
			
			
			
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItem3')
DROP PROCEDURE TempGetStateItem3	
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItem3')
DROP PROCEDURE TempGetStateItem3	
GO
        CREATE PROCEDURE [dbo].[TempGetStateItem3]
            @id         tSessionId,
            @itemShort  tSessionItemShort OUTPUT,
            @locked     bit OUTPUT,
            @lockAge    int OUTPUT,
            @lockCookie int OUTPUT,
            @actionFlags int OUTPUT
			WITH ENCRYPTION
        AS
            DECLARE @textptr AS tTextPtr
            DECLARE @length AS int
            DECLARE @now AS datetime
            SET @now = GETUTCDATE()

            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, @now), 
                @locked = Locked,
                @lockAge = DATEDIFF(second, LockDate, @now),
                @lockCookie = LockCookie,
                @itemShort = CASE @locked
                    WHEN 0 THEN SessionItemShort
                    ELSE NULL
                    END,
                @textptr = CASE @locked
                    WHEN 0 THEN TEXTPTR(SessionItemLong)
                    ELSE NULL
                    END,
                @length = CASE @locked
                    WHEN 0 THEN DATALENGTH(SessionItemLong)
                    ELSE NULL
                    END,

                /* If the Uninitialized flag (0x1) if it is set,
                   remove it and return InitializeItem (0x1) in actionFlags */
                Flags = CASE
                    WHEN (Flags & 1) <> 0 THEN (Flags & ~1)
                    ELSE Flags
                    END,
                @actionFlags = CASE
                    WHEN (Flags & 1) <> 0 THEN 1
                    ELSE 0
                    END
            WHERE SessionId = @id
            IF @length IS NOT NULL BEGIN
                READTEXT [RAM].dbo.ASPStateTempSessions.SessionItemLong @textptr 0 @length
            END

            RETURN 0      
GO





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItemExclusive')
DROP PROCEDURE TempGetStateItemExclusive
GO
        CREATE PROCEDURE [dbo].[TempGetStateItemExclusive]
            @id         tSessionId,
            @itemShort  tSessionItemShort OUTPUT,
            @locked     bit OUTPUT,
            @lockDate   datetime OUTPUT,
            @lockCookie int OUTPUT
			WITH ENCRYPTION
        AS
            DECLARE @textptr AS tTextPtr
            DECLARE @length AS int
            DECLARE @now AS datetime
            DECLARE @nowLocal AS datetime

            SET @now = GETUTCDATE()
            SET @nowLocal = GETDATE()
            
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, @now), 
                LockDate = CASE Locked
                    WHEN 0 THEN @now
                    ELSE LockDate
                    END,
                @lockDate = LockDateLocal = CASE Locked
                    WHEN 0 THEN @nowLocal
                    ELSE LockDateLocal
                    END,
                @lockCookie = LockCookie = CASE Locked
                    WHEN 0 THEN LockCookie + 1
                    ELSE LockCookie
                    END,
                @itemShort = CASE Locked
                    WHEN 0 THEN SessionItemShort
                    ELSE NULL
                    END,
                @textptr = CASE Locked
                    WHEN 0 THEN TEXTPTR(SessionItemLong)
                    ELSE NULL
                    END,
                @length = CASE Locked
                    WHEN 0 THEN DATALENGTH(SessionItemLong)
                    ELSE NULL
                    END,
                @locked = Locked,
                Locked = 1
            WHERE SessionId = @id
            IF @length IS NOT NULL BEGIN
                READTEXT [RAM].dbo.ASPStateTempSessions.SessionItemLong @textptr 0 @length
            END

            RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
GO	





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItemExclusive2')
DROP PROCEDURE TempGetStateItemExclusive2
GO
        CREATE PROCEDURE [dbo].[TempGetStateItemExclusive2]
            @id         tSessionId,
            @itemShort  tSessionItemShort OUTPUT,
            @locked     bit OUTPUT,
            @lockAge    int OUTPUT,
            @lockCookie int OUTPUT
			WITH ENCRYPTION
        AS
            DECLARE @textptr AS tTextPtr
            DECLARE @length AS int
            DECLARE @now AS datetime
            DECLARE @nowLocal AS datetime

            SET @now = GETUTCDATE()
            SET @nowLocal = GETDATE()
            
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, @now), 
                LockDate = CASE Locked
                    WHEN 0 THEN @now
                    ELSE LockDate
                    END,
                LockDateLocal = CASE Locked
                    WHEN 0 THEN @nowLocal
                    ELSE LockDateLocal
                    END,
                @lockAge = CASE Locked
                    WHEN 0 THEN 0
                    ELSE DATEDIFF(second, LockDate, @now)
                    END,
                @lockCookie = LockCookie = CASE Locked
                    WHEN 0 THEN LockCookie + 1
                    ELSE LockCookie
                    END,
                @itemShort = CASE Locked
                    WHEN 0 THEN SessionItemShort
                    ELSE NULL
                    END,
                @textptr = CASE Locked
                    WHEN 0 THEN TEXTPTR(SessionItemLong)
                    ELSE NULL
                    END,
                @length = CASE Locked
                    WHEN 0 THEN DATALENGTH(SessionItemLong)
                    ELSE NULL
                    END,
                @locked = Locked,
                Locked = 1
            WHERE SessionId = @id
            IF @length IS NOT NULL BEGIN
                READTEXT [RAM].dbo.ASPStateTempSessions.SessionItemLong @textptr 0 @length
            END

            RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
GO	




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetStateItemExclusive3')
DROP PROCEDURE TempGetStateItemExclusive3
GO	  
        CREATE PROCEDURE [dbo].[TempGetStateItemExclusive3]
            @id         tSessionId,
            @itemShort  tSessionItemShort OUTPUT,
            @locked     bit OUTPUT,
            @lockAge    int OUTPUT,
            @lockCookie int OUTPUT,
            @actionFlags int OUTPUT
			WITH ENCRYPTION
        AS
            DECLARE @textptr AS tTextPtr
            DECLARE @length AS int
            DECLARE @now AS datetime
            DECLARE @nowLocal AS datetime

            SET @now = GETUTCDATE()
            SET @nowLocal = GETDATE()
            
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, @now), 
                LockDate = CASE Locked
                    WHEN 0 THEN @now
                    ELSE LockDate
                    END,
                LockDateLocal = CASE Locked
                    WHEN 0 THEN @nowLocal
                    ELSE LockDateLocal
                    END,
                @lockAge = CASE Locked
                    WHEN 0 THEN 0
                    ELSE DATEDIFF(second, LockDate, @now)
                    END,
                @lockCookie = LockCookie = CASE Locked
                    WHEN 0 THEN LockCookie + 1
                    ELSE LockCookie
                    END,
                @itemShort = CASE Locked
                    WHEN 0 THEN SessionItemShort
                    ELSE NULL
                    END,
                @textptr = CASE Locked
                    WHEN 0 THEN TEXTPTR(SessionItemLong)
                    ELSE NULL
                    END,
                @length = CASE Locked
                    WHEN 0 THEN DATALENGTH(SessionItemLong)
                    ELSE NULL
                    END,
                @locked = Locked,
                Locked = 1,

                /* If the Uninitialized flag (0x1) if it is set,
                   remove it and return InitializeItem (0x1) in actionFlags */
                Flags = CASE
                    WHEN (Flags & 1) <> 0 THEN (Flags & ~1)
                    ELSE Flags
                    END,
                @actionFlags = CASE
                    WHEN (Flags & 1) <> 0 THEN 1
                    ELSE 0
                    END
            WHERE SessionId = @id
            IF @length IS NOT NULL BEGIN
                READTEXT [RAM].dbo.ASPStateTempSessions.SessionItemLong @textptr 0 @length
            END

            RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
GO   
  
  
  
  
  
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempGetVersion')
DROP PROCEDURE TempGetVersion                   
GO
CREATE PROCEDURE [dbo].[TempGetVersion]
    @ver      char(10) OUTPUT
	WITH ENCRYPTION
AS
    SELECT @ver = '2'
    RETURN 0
GO 





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempInsertStateItemLong')
DROP PROCEDURE TempInsertStateItemLong                   
GO    
        CREATE PROCEDURE [dbo].[TempInsertStateItemLong]
            @id         tSessionId,
            @itemLong   tSessionItemLong,
            @timeout    int
			WITH ENCRYPTION
        AS    
            DECLARE @now AS datetime
            DECLARE @nowLocal AS datetime
            
            SET @now = GETUTCDATE()
            SET @nowLocal = GETDATE()

            INSERT [RAM].dbo.ASPStateTempSessions 
                (SessionId, 
                 SessionItemLong, 
                 Timeout, 
                 Expires, 
                 Locked, 
                 LockDate,
                 LockDateLocal,
                 LockCookie) 
            VALUES 
                (@id, 
                 @itemLong, 
                 @timeout, 
                 DATEADD(n, @timeout, @now), 
                 0, 
                 @now,
                 @nowLocal,
                 1)

            RETURN 0  
GO
                   
				   
				   
				   
				   
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempInsertStateItemShort')
DROP PROCEDURE TempInsertStateItemShort                   
GO	
        CREATE PROCEDURE [dbo].[TempInsertStateItemShort]
            @id         tSessionId,
            @itemShort  tSessionItemShort,
            @timeout    int
			WITH ENCRYPTION
        AS    

            DECLARE @now AS datetime
            DECLARE @nowLocal AS datetime
            
            SET @now = GETUTCDATE()
            SET @nowLocal = GETDATE()

            INSERT [RAM].dbo.ASPStateTempSessions 
                (SessionId, 
                 SessionItemShort, 
                 Timeout, 
                 Expires, 
                 Locked, 
                 LockDate,
                 LockDateLocal,
                 LockCookie) 
            VALUES 
                (@id, 
                 @itemShort, 
                 @timeout, 
                 DATEADD(n, @timeout, @now), 
                 0, 
                 @now,
                 @nowLocal,
                 1)

            RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
GO	





IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempInsertUninitializedItem')
DROP PROCEDURE TempInsertUninitializedItem                   
GO
        CREATE PROCEDURE [dbo].[TempInsertUninitializedItem]
            @id         tSessionId,
            @itemShort  tSessionItemShort,
            @timeout    int
			WITH ENCRYPTION
        AS    

            DECLARE @now AS datetime
            DECLARE @nowLocal AS datetime
            
            SET @now = GETUTCDATE()
            SET @nowLocal = GETDATE()

            INSERT [RAM].dbo.ASPStateTempSessions 
                (SessionId, 
                 SessionItemShort, 
                 Timeout, 
                 Expires, 
                 Locked, 
                 LockDate,
                 LockDateLocal,
                 LockCookie,
                 Flags) 
            VALUES 
                (@id, 
                 @itemShort, 
                 @timeout, 
                 DATEADD(n, @timeout, @now), 
                 0, 
                 @now,
                 @nowLocal,
                 1,
                 1)

            RETURN 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempReleaseStateItemExclusive')
DROP PROCEDURE TempReleaseStateItemExclusive    
GO
        CREATE PROCEDURE [dbo].[TempReleaseStateItemExclusive]
            @id         tSessionId,
            @lockCookie int
			WITH ENCRYPTION
        AS
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, GETUTCDATE()), 
                Locked = 0
            WHERE SessionId = @id AND LockCookie = @lockCookie

            RETURN 0       
GO 		            










 IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempRemoveStateItem')
DROP PROCEDURE TempRemoveStateItem    
GO     
    CREATE PROCEDURE [dbo].[TempRemoveStateItem]
        @id     tSessionId,
        @lockCookie int
		WITH ENCRYPTION
    AS
        DELETE [RAM].dbo.ASPStateTempSessions
        WHERE SessionId = @id AND LockCookie = @lockCookie
        RETURN 0 
GO
              
			  
			  
			  
			  
			  
 IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempResetTimeout')
DROP PROCEDURE TempResetTimeout    
GO 
        CREATE PROCEDURE [dbo].[TempResetTimeout]
            @id     tSessionId
			WITH ENCRYPTION
        AS
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, Timeout, GETUTCDATE())
            WHERE SessionId = @id
            RETURN 0   
GO	






 IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempUpdateStateItemLong')
DROP PROCEDURE TempUpdateStateItemLong    
GO 		   
        CREATE PROCEDURE [dbo].[TempUpdateStateItemLong]
            @id         tSessionId,
            @itemLong   tSessionItemLong,
            @timeout    int,
            @lockCookie int
			WITH ENCRYPTION
        AS    
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, @timeout, GETUTCDATE()), 
                SessionItemLong = @itemLong,
                Timeout = @timeout,
                Locked = 0
            WHERE SessionId = @id AND LockCookie = @lockCookie

            RETURN 0  
GO          






 
  IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempUpdateStateItemLongNullShort')
DROP PROCEDURE TempUpdateStateItemLongNullShort    
GO 	 
        CREATE PROCEDURE [dbo].[TempUpdateStateItemLongNullShort]
            @id         tSessionId,
            @itemLong   tSessionItemLong,
            @timeout    int,
            @lockCookie int
			WITH ENCRYPTION
        AS    
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, @timeout, GETUTCDATE()), 
                SessionItemLong = @itemLong, 
                SessionItemShort = NULL,
                Timeout = @timeout,
                Locked = 0
            WHERE SessionId = @id AND LockCookie = @lockCookie

            RETURN 0 
GO      







IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempUpdateStateItemShort')
DROP PROCEDURE TempUpdateStateItemShort    
GO       
        CREATE PROCEDURE [dbo].[TempUpdateStateItemShort]
            @id         tSessionId,
            @itemShort  tSessionItemShort,
            @timeout    int,
            @lockCookie int
			WITH ENCRYPTION
        AS    
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, @timeout, GETUTCDATE()), 
                SessionItemShort = @itemShort, 
                Timeout = @timeout,
                Locked = 0
            WHERE SessionId = @id AND LockCookie = @lockCookie

            RETURN 0  
GO     








IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resources_In_Radius')
DROP PROCEDURE Proc_Search_Resources_In_Radius   
GO
CREATE PROCEDURE [dbo].[Proc_Search_Resources_In_Radius] 
	-- Add the parameters for the stored procedure here
@StartLatitude NUMERIC(18,10) = 43.654490,
@StartLongitude NUMERIC(18,10) = -79.387419,
@Radius NUMERIC(18,10) = 5.00 ,
@lang NVARCHAR(50) = N'en',
@token NVARCHAR(50) -- ='1CD59756-D237-4792-A1A4-65B32740C7AF'     --CAMH
-- declare @token NVARCHAR(50) ='9BB1408A-81DD-43D1-B621-83E2F71D2669'   --KHP
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
 

 

----------------------------------------------------
--  search resources within  
----------------------------------------------------
SELECT distinct
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, a.SubCategoryID
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, A.[PhysicalAddress]
				, A.[PhysicalAddressIsPrivate]
				, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
				, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
				, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
				, a.Latitude
				, a.Longitude
				, a.Phone
				, a.WebsiteAddress
FROM            RamResource AS a 
                    INNER JOIN    CityLocation AS c ON a.PhysicalCityID = c.CityId 
                    INNER JOIN     Province AS p ON a.PhysicalProvinceID = p.ProvinceID 
                    INNER JOIN     ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID 
                    INNER JOIN     SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID 
                    INNER JOIN     TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID 
					-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE			[dbo].[fnCalcDistanceKM](@StartLatitude, @StartLongitude, a.Latitude, a.Longitude) < @Radius AND a.PhysicalCityID != 0   AND SC.Active = 1 AND TC.Active = 1 
ORDER BY        a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID, 
END
GO














IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resource_by_City')
DROP PROCEDURE Proc_Search_Resource_by_City   
GO
CREATE PROCEDURE [dbo].[Proc_Search_Resource_by_City] 
@CityID int,
@lang nvarchar(50) = 'en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;



SELECT	DISTINCT
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, A.[PhysicalAddress]
				, A.PhysicalAddressIsPrivate 
				, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
				, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
				, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
				, a.Latitude
				, a.Longitude
				, a.Phone
				, a.WebsiteAddress
FROM            RamResource AS a 
				INNER JOIN  F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
				INNER JOIN	F_Get_ALL_Allow_City(@token) AS ACID ON ACID.CityID = A.PhysicalCityID -- Return only those resources whose PhysicalCityID is in the allowing City list
                INNER JOIN  CityLocation AS c   ON a.PhysicalCityID = c.CityId 
                INNER JOIN  Province     AS p   ON a.PhysicalProvinceID = p.ProvinceID 
                INNER JOIN  ETLLoad      AS ETL ON a.ETLLoadID = ETL.ETLLoadID 
                INNER JOIN  SubCategory  AS SC  ON SC.SubCategoryID = a.SubCategoryID 
                INNER JOIN  TopCategory  AS TC  ON TC.TopCategoryID = a.TOPCategoryID

WHERE [PhysicalCityID] = @CityID and a.LanguageOfRecord  = @lang    AND SC.Active = 1 AND TC.Active = 1 
ORDER BY  a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID,
END
GO




IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resource_by_Province')
DROP PROCEDURE Proc_Search_Resource_by_Province   
GO
CREATE PROCEDURE [dbo].[Proc_Search_Resource_by_Province] 

@ProvinceID int,
@lang nvarchar(50) = 'en',
@TOKEN nvarchar(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
DECLARE @V INT -- 
SELECT TOP(1)  @V = ProvinceID    FROM    [dbo].[F_Get_Allow_Province] (@token)
IF @V = 0 
	BEGIN   -- allow access all provinces 
			SELECT       DISTINCT 
								a.ETLLoadID
								, a.ResourceAgencyNum
								, Map
								, A.[SubCategoryID]
								, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
								, A.[TOPCategoryID]
								, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
								, A.[PublicName] AS [Name]
								, A.[PhysicalAddress]
								, A.[PhysicalAddressIsPrivate]
								, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
								, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
								, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
								, a.Latitude
								, a.Longitude
								, a.Phone
								, a.WebsiteAddress
				FROM            RamResource AS a 
									INNER JOIN      CityLocation AS c	ON a.PhysicalCityID = c.CityId 
									INNER JOIN      Province AS p		ON a.PhysicalProvinceID = p.ProvinceID  
									INNER JOIN      ETLLoad AS ETL		ON a.ETLLoadID = ETL.ETLLoadID  
									INNER JOIN      SubCategory AS SC	ON SC.SubCategoryID = a.SubCategoryID  
									INNER JOIN      TopCategory AS TC	ON TC.TopCategoryID = a.TOPCategoryID
									-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
									INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC		ON ATC.TopCategoryID = A.TOPCategoryID 

	WHERE [PhysicalProvinceID] = @ProvinceID  and a.LanguageOfRecord = @lang    AND SC.Active = 1 AND TC.Active = 1 
	ORDER BY         a.TOPCategoryID,  a.SubCategoryID, a.Map
	--a.PhysicalProvinceID, a.PhysicalCityID,
	END
ELSE  --  allow access specific provinces
	BEGIN
		SELECT       DISTINCT 
						a.ETLLoadID
						, a.ResourceAgencyNum
						, Map
						, A.[SubCategoryID]
						, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
						, A.[TOPCategoryID]
						, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
						, A.[PublicName] AS [Name]
						, A.[PhysicalAddress]
						, A.[PhysicalAddressIsPrivate]
						, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
						, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
						, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
						, a.Latitude
						, a.Longitude
						, a.Phone
						, a.WebsiteAddress
		FROM            RamResource AS a 
							INNER JOIN      CityLocation AS c	ON a.PhysicalCityID = c.CityId 
							INNER JOIN      Province AS p		ON a.PhysicalProvinceID = p.ProvinceID  
							INNER JOIN      ETLLoad AS ETL		ON a.ETLLoadID = ETL.ETLLoadID  
							INNER JOIN      SubCategory AS SC	ON SC.SubCategoryID = a.SubCategoryID  
							INNER JOIN      TopCategory AS TC	ON TC.TopCategoryID = a.TOPCategoryID
							-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
							INNER JOIN		F_Get_Allow_TopCategory (@token) AS ATC		ON ATC.TopCategoryID = A.TOPCategoryID 
							-- Return only those resources whose PhysicalCityID is in the allowing PROVINCE list
							INNER JOIN		F_Get_Allow_Province (@token)  AS APID		ON APID.ProvinceID = A.PhysicalProvinceID 
							-- Return only those resources whose PhysicalCityID is in the allowing City list
							INNER JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
		WHERE [PhysicalProvinceID] = @ProvinceID  and a.LanguageOfRecord = @lang    AND SC.Active = 1 AND TC.Active = 1 
		ORDER BY         a.TOPCategoryID,  a.SubCategoryID, a.Map
		--a.PhysicalProvinceID, a.PhysicalCityID,
	END
END

GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resource_by_SubCategory')
DROP PROCEDURE Proc_Search_Resource_by_SubCategory   
GO
CREATE PROCEDURE [dbo].[Proc_Search_Resource_by_SubCategory] 
@SubCategoryID int,
@lang nvarchar(50) ='en',
@token NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT       DISTINCT
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, A.[PhysicalAddress]
				, A.[PhysicalAddressIsPrivate]
				, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
				, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
				, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
				, a.Latitude
				, a.Longitude
				, a.Phone
				, a.WebsiteAddress
FROM            RamResource AS a  
                      INNER JOIN   CityLocation AS c ON a.PhysicalCityID = c.CityId  
                      INNER JOIN   Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
                      INNER JOIN   ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
                      INNER JOIN   SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
                      INNER JOIN   TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID
					  INNER JOIN	F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					  INNER JOIN	F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID -- Return only those resources whose PhysicalCityID is in the allowing City list

WHERE a.SubCategoryID = @SubCategoryID and a.LanguageOfRecord = @lang   AND SC.Active = 1 AND TC.Active = 1 
ORDER BY         a.TOPCategoryID,  a.SubCategoryID, a.Map
-- a.PhysicalProvinceID, a.PhysicalCityID,
END
GO






IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resource_by_TopCategory')
DROP PROCEDURE Proc_Search_Resource_by_TopCategory   
GO
CREATE PROCEDURE [dbo].[Proc_Search_Resource_by_TopCategory] 
@TOPCategoryID int,
@lang nvarchar(50) = 'en',
@TOKEN NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON;


SELECT       DISTINCT
				a.ETLLoadID
				, a.ResourceAgencyNum
				, Map
				, A.SubCategoryID
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, A.[PhysicalAddress]
				, A.[PhysicalAddressIsPrivate]
				, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
				, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
				, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
				, a.Latitude
				, a.Longitude
				, a.Phone
				, a.WebsiteAddress
FROM            RamResource AS a 
                    INNER JOIN     CityLocation AS c ON a.PhysicalCityID = c.CityId  
                    INNER JOIN     Province AS p ON a.PhysicalProvinceID = p.ProvinceID  
                    INNER JOIN     ETLLoad AS ETL ON a.ETLLoadID = ETL.ETLLoadID  
                    INNER JOIN     SubCategory AS SC ON SC.SubCategoryID = a.SubCategoryID  
                    INNER JOIN     TopCategory AS TC ON TC.TopCategoryID = a.TOPCategoryID
					 -- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					INNER JOIN	F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					INNER JOIN	F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
WHERE a.TOPCategoryID = @TOPCategoryID  and a.LanguageOfRecord = @lang  AND SC.Active = 1 AND TC.Active = 1 
ORDER BY         a.TOPCategoryID,  a.SubCategoryID, a.Map
--a.PhysicalProvinceID, a.PhysicalCityID,
END
GO


















    
	
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'TempUpdateStateItemShortNullLong')
DROP PROCEDURE TempUpdateStateItemShortNullLong    
GO 	
        CREATE PROCEDURE [dbo].[TempUpdateStateItemShortNullLong]
            @id         tSessionId,
            @itemShort  tSessionItemShort,
            @timeout    int,
            @lockCookie int
			WITH ENCRYPTION
        AS    
            UPDATE [RAM].dbo.ASPStateTempSessions
            SET Expires = DATEADD(n, @timeout, GETUTCDATE()), 
                SessionItemShort = @itemShort, 
                SessionItemLong = NULL, 
                Timeout = @timeout,
                Locked = 0
            WHERE SessionId = @id AND LockCookie = @lockCookie

            RETURN 0  
GO



-- ==============================================================================================================
-- Added on July 20, 2016 


IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'F_Get_Allow_TopCategory')
DROP FUNCTION F_Get_Allow_TopCategory 
GO
-- =============================================
-- Author:		William Chen
-- Create date: July 21, 2016
-- Description:	According to access token to get the KHP authorised topcategory list
--              if the list is NULL, means did not authorise, 
--              if the topcategoryID = 0; means allow access all of category list.
-- =============================================
CREATE FUNCTION F_Get_Allow_TopCategory
(
 @token nvarchar(50)
)
RETURNS 
@AllowTopCategoryIDList TABLE 
(
TopCategoryID int
)
 WITH ENCRYPTION
AS
BEGIN
-----------------------------------------------
--  Process allow accessing TopCategory List
-----------------------------------------------
DECLARE @V INT;
SELECT TOP (1) @V =  p.TopCategoryID  FROM Permission  as p 
				JOIN AccessControlList AS a ON a.ACLID  = p.ACLID 
	WHERE a.ACLToken = @token
	ORDER BY p.TopCategoryID;



IF @V=0
	BEGIN -- allow access all of TopCategories
		INSERT INTO @AllowTopCategoryIDList
			SELECT TopCategoryID FROM [dbo].[TopCategory] WHERE [Active] = 1
	END
ELSE  -- allow access specific TopCategories 
	BEGIN
		INSERT INTO @AllowTopCategoryIDList
		SELECT DISTINCT p.TopCategoryID AS [TopCategoryID] FROM Permission  as p 
				JOIN AccessControlList AS a ON a.ACLID  = p.ACLID 
		WHERE a.ACLToken = @token
		ORDER BY p.TopCategoryID
	END

RETURN 
END
GO















IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'F_Get_Allow_Province')
DROP FUNCTION F_Get_Allow_Province 
GO
-- =============================================
-- Author:		William Chen
-- Create date: July 21, 2016
-- Description:	According to access token to get the KHP authorised Province list
--              if the list is NULL, means did not authorise, 
--              if the ProvinceID = 0; means allow access all of Province.
-- =============================================
CREATE FUNCTION [dbo].[F_Get_Allow_Province]
(
 @token nvarchar(50)
)
RETURNS 
@AllowProvinceIDList TABLE 
(
	-- Add the column definitions for the TABLE variable here
ProvinceID int
)
 WITH ENCRYPTION
AS
BEGIN
	-- Fill the table variable with the rows for your result set
	INSERT INTO @AllowProvinceIDList
	SELECT DISTINCT p.ProvinceID   FROM [dbo].[Permission] as p 
				join [dbo].[AccessControlList] as acl  on p.aclid= acl.aclid  
		WHERE acl.acltoken = @token
		ORDER BY p.ProvinceID
	
	RETURN 
END
GO











IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'F_GetAllowCity_By_Province')
DROP FUNCTION F_GetAllowCity_By_Province 
GO
-- =======================================================================================
-- Author:		William Chen
-- Create date: Augest 2, 2016
-- Description:	Based on provinceID, find out allow access city list from Table Permission CityLocation
-- =======================================================================================
CREATE FUNCTION F_GetAllowCity_By_Province 
(
	-- Add the parameters for the function here
@ProvinceID int,
@TOKEN NVARCHAR(50)
)
RETURNS 
@allowcitylistByPid TABLE 
(
pid int,
cid int
)
 WITH ENCRYPTION
AS
BEGIN
	-- Fill the table variable with the rows for your result set
	 
	 DECLARE @ACLID INT 
	 SELECT @ACLID = ACLID FROM AccessControlList WHERE ACLToken  = @TOKEN
	 DECLARE @C TABLE ( c INT) ;
	 INSERT INTO @C 
		SELECT  CityID FROM [dbo].[Permission] WHERE (ProvinceID = @ProvinceID)   AND  (ACLID = @aclid)     ORDER BY CityID ;

		DECLARE @vv int
		SELECT TOP(1) @VV = c FROM @C;

		IF  @VV = -1   --- ALLOW ACCESS ANY CITY IN THIS PROVINCE
			BEGIN
				INSERT INTO @allowcitylistByPid
				SELECT [ProvinceID], [CityId]  FROM [dbo].[CityLocation] WHERE  [ProvinceID] = @ProvinceID ORDER BY  PROVINCEID,CITYID
				RETURN
			END
		ELSE
			BEGIN
				INSERT INTO @allowcitylistByPid
				SELECT [ProvinceID], [CityId]  FROM  [dbo].[Permission]  WHERE ProvinceID = @ProvinceID    AND   (@ACLID = ACLID)   ORDER BY ProvinceID , CityID 
				RETURN
			END


	RETURN 
END
GO















IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'F_Get_ALL_Allow_City')
DROP FUNCTION F_Get_ALL_Allow_City 
GO
-- ============================================================================
-- Author:		William Chen
-- Create date: July 21, 2016
-- Description:	According to access token to get the KHP authorised City list
--              if the list is NULL, means did not authorise, 
--              if the CityID = -1; means allow access all of Province.
-- ============================================================================
CREATE FUNCTION [dbo].[F_Get_ALL_Allow_City]
(
	-- Add the parameters for the function here
 @token nvarchar(50)
)
RETURNS 
@AllowCityIDList TABLE 
(
	-- Add the column definitions for the TABLE variable here
CityID int
)
 WITH ENCRYPTION
AS
BEGIN
	DECLARE @ACLID INT
	-- Find out client number ACLID
	SELECT @ACLID = ACLID FROM AccessControlList WHERE @TOKEN = ACLToken;  

	IF @aclid IS NULL 
		RETURN   -- DID NOT FIND THIS CLIENT, RETURN NULL
	 ELSE
		BEGIN
			DECLARE @AllowProvinceIDList TABLE (ProvinceID int)
			-- Find out allowing access province list
			INSERT INTO @AllowProvinceIDList SELECT DISTINCT PROVINCEID FROM Permission WHERE ACLID = @ACLID ORDER BY PROVINCEID
		END

	DECLARE @V INT
	SELECT TOP (1)  @V = PROVINCEID FROM  @AllowProvinceIDList  -- Find out the mimimum ProvinceID 
	IF @V = 0 
		BEGIN   -- means allow access all of provinces
			INSERT INTO @AllowCityIDList
					SELECT [CityId] AS [CityID] FROM [dbo].[CityLocation] ORDER BY [CityId]
			RETURN   -- Return all Cityid
		END
	ELSE       -- means all access specific provinces
		BEGIN
			INSERT INTO @AllowCityIDList
					SELECT ACID.cid  FROM @AllowProvinceIDList AS APID CROSS APPLY  [dbo].[F_GetAllowCity_By_Province] (APID.ProvinceID, @token) AS ACID
					ORDER BY ACID.cid
		END
	RETURN 
END
GO










IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'F_Extract_Text_Between_Quotation')
DROP FUNCTION F_Extract_Text_Between_Quotation 
GO

-- =============================================
-- Author:		William Chen
-- Create date: Aug.8, 2016
-- Description:	Extract text between double quotation mark, so that the key works can be searched as whole section
-- Example: when user enter "24.7 "
-- Default delimiter is double qutiation "
-- =============================================
CREATE FUNCTION F_Extract_Text_Between_Quotation 
(
	-- Add the parameters for the function here
	@kws NVARCHAR(4000)
)
RETURNS NVARCHAR(4000)
WITH ENCRYPTION
AS
BEGIN
	-- Declare the return variable here
	DECLARE @words NVARCHAR(4000);
	DECLARE @delimiter NVARCHAR(5) = '"' ;  -- delimiter mark, here is double quotation "

		SET @words = LTRIM(RTRIM(@KWS)); -- remove any space front and rear 
		DECLARE @Orginal_len INT = LEN(@words);  -- inpute key words length, includes quotation mark 
		DECLARE @first INT = CHARINDEX( @delimiter, @words); -- the first quotation index
		DECLARE @last INT = CHARINDEX(    @delimiter,   REVERSE(@words)  ); -- last qutation index

		declare @myvar nvarchar(4000) = @words; -- Declare a test variable to how many quotation are there in the keywors 
		set @myvar = replace (@myvar, '"','')  -- remove double quotation marks
	 
		-- process trailing space issue
		-- this LEN(REPLACE(@myvar, @delimiter,'') + 'a') -1 solve SQL Server LEN function not including trailing spaces
		set @myvar = @myvar + 'a';  -- in case, there are spaces before last double quotation mark
		declare @final_len int
		set @final_len = len(@myvar)-1;  -- because above add a char 'a', so here his lenth should min 1


		IF ((@Orginal_len - @final_len = 2) AND (@first = 1) AND (@last = 1)) 
			BEGIN -- Quotation in a pair, 1st quotation is at 1st letter, and last quotation is at last letter
				DECLARE @bl int = @Orginal_len - @first - @last  -- how many letters are there between the first quotation" and the last Quotation "
				SET @words = SUBSTRING (@words,  CHARINDEX(@delimiter, @words) + 1,  @bl  );
				SET @words = LTRIM(RTRIM(@words)); -- remove any space front and rear AGAIN
			END
		ELSE   -- Quotation is NOT in pair; or are not at 1st and last letter
			BEGIN
				SET @words = '';  -- return a empty string, do not need process
			END

	-- Return the result of the function
	RETURN @words

END
GO














IF EXISTS (SELECT * FROM sys.objects WHERE type IN (N'FN', N'IF', N'TF') AND name = 'F_Splite_Coverage_into_word')
DROP FUNCTION F_Splite_Coverage_into_word 
GO
-- ==========================================================================================
-- Author:		William Chen
-- Create date: Aug.25, 2016
-- Description:	Splite column Coverage from table RAMResource into single word. 
-- ==========================================================================================
CREATE FUNCTION F_Splite_Coverage_into_word 
(
	-- Add the parameters for the function here
@id int
)
RETURNS 
@T_KEYWORD TABLE 
(
  ID int,
  KEYWORD nvarchar(100)
)
WITH ENCRYPTION
AS
BEGIN
	 --  @s 待分拆的字符串 
DECLARE @s   varchar(max) ;
select @s=[Coverage] from  [dbo].[RamResource]   where ETLLOadID = @id;
--- remove last ";" or "space"
  Select @s = SUBSTRING(@s, 0, LEN(@s)+1)
--- "*" convert to ";"
 select @s =  REPLACE(@s,'*',';') ;
 --- "-" convert to ";"
 select @s =  REPLACE(@s,'-',';') ;
  --- " " space convert to ";"
 select @s =  REPLACE(@s,' ',';') ;
   --- "/" convert to ";"
 select @s =  REPLACE(@s,'/',';') ;

 
  --数据分隔符
 DECLARE @splitlen int;
 SET @splitlen=LEN(';'+'a')-2;
	

	 WHILE CHARINDEX(';',@s)>0
		 BEGIN

			if (not exists (select KEYWORD from @T_KEYWORD where KEYWORD =   LEFT(@s,CHARINDEX(';',@s)-1)))
				INSERT into  @T_KEYWORD  (id, KEYWORD) VALUES( @ID, LEFT(@s,CHARINDEX(';',@s)-1) )  ;
 
			SET @s=RTRIM(LTRIM(STUFF(@s,1,CHARINDEX(';',@s)+@splitlen,'')));
 
		 END;

 if ( not exists (select KEYWORD from  @T_KEYWORD where KEYWORD = @s) )
 INSERT into  @T_KEYWORD  (ID, KEYWORD) VALUES(@ID, @s);


 DELETE FROM	@T_KEYWORD    WHERE     LEN ([KEYWORD]) <  1  ;

	RETURN 
END
GO

















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Search_Resource_By_Coverage')
DROP PROCEDURE Proc_Search_Resource_By_Coverage 
GO
-- =======================================================================================================================================
-- Author:		William Chen
-- Create date: Aug.29, 2016
-- Description:	Accounting to access to token, get resource by its coverage, and filter by language.  
-- =======================================================================================================================================
CREATE PROCEDURE Proc_Search_Resource_By_Coverage 
 @s nvarchar (255)  ,
 @lang nvarchar(50)  ,
 @token nvarchar(50)  
 with encryption
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
Set @s = LTRIM(RTRIM(@s))  ;
SELECT			DISTINCT
				a.etlloadid
				, a. coverage 
				, a.ResourceAgencyNum
				, Map
				, A.[SubCategoryID]
				, CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS [SubCategory]
				, A.[TOPCategoryID]
				, CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS [TopCategory]
				, A.[PublicName] AS [Name]
				, A.[PhysicalAddress]
				, A.PhysicalAddressIsPrivate 
				, CASE C.CityName  	WHEN 'TBD' THEN '' ELSE C.CityName END AS [City]
				, CASE P.[Province]   WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE P.[Province] END AS [Province]
				, REPLACE(ETL.TaxonomyTerm,'/',' ')  AS STerm
				, a.Latitude
				, a.Longitude
				, a.Phone
				, a.WebsiteAddress
FROM ramresource as a  
					-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
		 
					JOIN [dbo].[SubCategory] AS SC	ON SC.[SubCategoryID] = A.SubCategoryID
					JOIN [dbo].[TopCategory] AS TC	ON TC.TopCategoryID = A.TOPCategoryID
					INNER JOIN  CityLocation AS c   ON a.PhysicalCityID = c.CityId 
					INNER JOIN  Province     AS p   ON a.PhysicalProvinceID = p.ProvinceID 
					INNER JOIN  ETLLoad      AS ETL ON a.ETLLoadID = ETL.ETLLoadID 
					CROSS APPLY 	( 
										select 　   f.id,  f.KEYWORD   from   F_Splite_Coverage_into_word   (a.etlloadid )  as f  
									)  AS K	
WHERE   a.LanguageOfRecord = @lang     
		AND		SC.Active = 1   
		AND		TC.Active = 1   
		AND		K.KEYWORD  like   ''   + @s  +   '%'  +  ''  
ORDER BY  a.TOPCategoryID,  a.SubCategoryID, a.Map



END
GO













IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Resource_By_Coverage')
DROP PROCEDURE Proc_Get_Resource_By_Coverage 
-- =======================================================================================================================================
-- Author:		William Chen
-- Create date: Aug.29, 2016
-- Description:	Accounting to access to token, get resource by its coverage, and filter by language.  
-- =======================================================================================================================================
GO
CREATE PROCEDURE Proc_Get_Resource_By_Coverage 
 @s nvarchar (255)  ,
 @lang nvarchar(50)  ,
 @token nvarchar(50)  
 WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	Set @s = LTRIM(RTRIM(@s))  ;


	SELECT		DISTINCT
						a.ETLLoadID, 
						a.ResourceAgencyNum,
						a.Map, 
						a.SubCategoryID, 
						CASE @lang WHEN 'EN' THEN SC.SubCategory ELSE SC.SubCategory_fr END AS SubCategory, 
						a.TOPCategoryID, 
                        CASE @lang WHEN 'EN' THEN TC.TopCategory ELSE TC.TopCategory_fr END AS TopCategory, 
						a.PublicName AS Name, 
						--CASE c.CityName WHEN 'TBD' THEN a.publicname ELSE CONVERT(NVARCHAR(2000), 
                        --a.publicname + ', ' + c.CityName + ', ' + p.[ProvinceAlias]) END AS PublicNames, 
						a.AgencyDescription, 
						a.PhysicalAddress, 
						a.PhysicalCityID, 
                        CASE c.CityName WHEN 'TBD' THEN '' ELSE c.CityName END AS City, 
						a.PhysicalProvinceID, 
						CASE p.[ProvinceAlias] WHEN 'OTHS' THEN '' WHEN 'Others' THEN '' ELSE p.[ProvinceAlias] END AS Province, 
                        a.PhysicalCountry, 
						a.PhysicalPostalCode, 
						REPLACE(ETL.TaxonomyTerm, '/', ' ') AS STerm, 
						REPLACE(ETL.TaxonomyTerms, '/', ' ') AS LTerms, 
						a.PhysicalAddressIsPrivate, 
						a.Latitude, 
						a.Longitude, 
                        a.HoursOfOperation, 
						a.Phone, 
						a.WebsiteAddress, 
						a.Eligibility, 
						a.DisabilitiesAccess, 
						a.FeeStructureSource, 
						a.ApplicationProcess, 
						a.DocumentsRequired, 
						a.LanguagesOfferedList, 
						a.LanguageOfRecord, 
                        a.WorkHours, 
						a.CustomEligibilitybyAge, 
						a.Coverage, 
						a.CoverageArea, 
						a.NormalWaitTime 
	FROM ramresource as a  
					-- Return only those resources whose TopCategoryID is in the allowing TopCategory list
					JOIN		F_Get_Allow_TopCategory (@token) AS ATC ON ATC.TopCategoryID = A.TOPCategoryID 
					-- Return only those resources whose PhysicalCityID is in the allowing City list
					JOIN		F_Get_ALL_Allow_City  (@token)  AS ACID ON ACID.CityID = A.PhysicalCityID 
		 
					JOIN [dbo].[SubCategory] AS SC	ON SC.[SubCategoryID] = A.SubCategoryID
					JOIN [dbo].[TopCategory] AS TC	ON TC.TopCategoryID = A.TOPCategoryID
					INNER JOIN  CityLocation AS c   ON a.PhysicalCityID = c.CityId 
					INNER JOIN  Province     AS p   ON a.PhysicalProvinceID = p.ProvinceID 
					INNER JOIN  ETLLoad      AS ETL ON a.ETLLoadID = ETL.ETLLoadID 
					CROSS APPLY 	( 
										select 　   f.id,  f.KEYWORD   from   F_Splite_Coverage_into_word   (a.etlloadid )  as f  
									)  AS K	
	WHERE   a.LanguageOfRecord = @lang     
			AND		SC.Active = 1   
			AND		TC.Active = 1   
			AND		K.KEYWORD  like   ''   + @s  +   '%'  +  ''  
	ORDER BY  a.TOPCategoryID,  a.SubCategoryID, a.Map


END
GO



















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'new_lookup_process')
DROP PROCEDURE new_lookup_process
GO
-- =============================================
-- Author:		William Chen
-- Create date: Long long ago
-- Description:	To manually inspect resource logic ,use below codes and uncomment them
-- =============================================
CREATE PROCEDURE [dbo].[new_lookup_process]
 @ETLLOADID int
 WITH ENCRYPTION
AS
BEGIN
SET NOCOUNT ON;
select 'Program' as [Program],etlloadid , ResourceAgencyNum,publicname, TaxonomyLevelNameID , ParentAgency, ParentAgencyNum,Phone1Number,PhysicalAddress1 ,PhysicalCity, PhysicalStateProvince, ConnectsToProgramNum ,ConnectsToSiteNum,latitude, longitude 
		from TaxonomyRAW where ETLLOADID=@ETLLOADID
declare @resourceagencynum varchar(50);
select @resourceagencynum = resourceagencynum from TaxonomyRAW where ETLLOADID=@ETLLOADID; 
print '@resourceagencynum='+ @resourceagencynum;

declare @ParentAgencyNum varchar(50)
select @ParentAgencyNum=ParentAgencyNum  from TaxonomyRAW where ETLLOADID=@ETLLOADID; 
print '@ParentAgencyNum = '+@ParentAgencyNum;

----all @ParentAgencyNum   related records
select 'The sameParentAgencyNum' as [sameParentAgencyNum], etlloadid , ResourceAgencyNum,publicname, t.TaxonomyLevelName , ParentAgency, ParentAgencyNum,Phone1Number,PhysicalAddress1 ,PhysicalCity, PhysicalStateProvince, ConnectsToProgramNum ,ConnectsToSiteNum,latitude, longitude 
		from [dbo].[RAMRAW] as r  JOIN [dbo].[TaxonomyLevelName] as t on t.TaxonomyLevelNameID = r.TaxonomyLevelNameID  where ParentAgencyNum=@ParentAgencyNum

----program at site
select 'program_at_site' as [program_at_site],etlloadid , ResourceAgencyNum,publicname, t.TaxonomyLevelName  , ParentAgency, ParentAgencyNum,Phone1Number,PhysicalAddress1 ,PhysicalCity, PhysicalStateProvince, ConnectsToProgramNum ,ConnectsToSiteNum,latitude, longitude 
		from [dbo].[RAMRAW] as r  JOIN [dbo].[TaxonomyLevelName] as t on t.TaxonomyLevelNameID = r.TaxonomyLevelNameID    where ParentAgencyNum=@ParentAgencyNum and t.TaxonomyLevelNameID  =4 and ConnectsToProgramNum = @resourceagencynum


----site
declare @connectstositenum varchar(50)
select  @connectstositenum = connectstositenum from [dbo].[RAMRAW] where ParentAgencyNum=@ParentAgencyNum and TaxonomyLevelNameID =4 and ConnectsToProgramNum = @resourceagencynum; print '@connectstositenum='+ @connectstositenum;
select 'SITE' as [site], etlloadid , ResourceAgencyNum,publicname, t.TaxonomyLevelName  , ParentAgency, ParentAgencyNum,Phone1Number,PhysicalAddress1 ,PhysicalCity, PhysicalStateProvince, ConnectsToProgramNum ,ConnectsToSiteNum,latitude, longitude
		from [dbo].[RAMRAW] as r  JOIN [dbo].[TaxonomyLevelName] as t on t.TaxonomyLevelNameID = r.TaxonomyLevelNameID    where ResourceAgencyNum=@connectstositenum


----agency
select 'Agency' as [agency],etlloadid , ResourceAgencyNum,publicname, t.TaxonomyLevelName  , ParentAgency, ParentAgencyNum,Phone1Number,PhysicalAddress1 ,PhysicalCity, PhysicalStateProvince, ConnectsToProgramNum ,ConnectsToSiteNum,latitude, longitude
		from [dbo].[RAMRAW] as r  JOIN [dbo].[TaxonomyLevelName] as t on t.TaxonomyLevelNameID = r.TaxonomyLevelNameID   where ResourceAgencyNum = @ParentAgencyNum  and t.TaxonomyLevelNameID =1 order by etlloadid



END
GO





















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'new_select_interest_fields')
DROP PROCEDURE new_select_interest_fields
GO
-- ===============================================================================================
-- Author:		William Chen
-- Create date: Sept.15, 2015
-- Description:	Select the most interesting fields from ETLLOAD TABLE
-- ===============================================================================================
CREATE PROCEDURE  [dbo].[new_select_interest_fields]
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT [ETLLoadID]
      ,[ResourceAgencyNum]      ,[PublicName]      ,[TaxonomyLevelName]      ,[ParentAgency]      ,[ParentAgencyNum]      ,[MailingAttentionName]
      ,[MailingAddress1]      ,[MailingAddress2]      ,[MailingCity]      ,[MailingStateProvince]
      ,[MailingPostalCode]      ,[MailingCountry]      ,[MailingAddressIsPrivate]      ,[PhysicalAddress1]
      ,[PhysicalAddress2]      ,[PhysicalCity]      ,[PhysicalCounty]      ,[PhysicalStateProvince]      ,[PhysicalPostalCode]
      ,[PhysicalCountry]      ,[PhysicalAddressIsPrivate]      ,[OtherAddress1]      ,[OtherAddress2]      ,[OtherCity]      ,[OtherCounty]
      ,[OtherStateProvince]      ,[OtherPostalCode]      ,[OtherCountry]      ,[Latitude]      ,[Longitude]      ,[HoursOfOperation]
      ,[Phone1Number]      ,[Phone1Name]      ,[Phone1Description]      ,[Phone1IsPrivate]      ,[Phone1Type]      ,[Phone2Number]      ,[Phone2Name]
      ,[Phone2Description]      ,[Phone2IsPrivate]      ,[Phone2Type]      ,[Phone3Number]      ,[Phone3Name]      ,[Phone3Description]
      ,[Phone3IsPrivate]      ,[Phone3Type]      ,[Phone4Number]      ,[Phone4Name]      ,[Phone4Description]      ,[Phone4IsPrivate]
      ,[Phone4Type]      ,[Phone5Number]      ,[Phone5Name]      ,[Phone5Description]      ,[Phone5IsPrivate]      ,[Phone5Type]
      ,[PhoneFax]      ,[PhoneFaxDescription]      ,[PhoneFaxIsPrivate]      ,[PhoneTTY]      ,[PhoneTTYDescription]      ,[PhoneTTYIsPrivate]
      ,[PhoneTollFree]      ,[PhoneTollFreeDescription]      ,[PhoneTollFreeIsPrivate]      ,[PhoneNumberHotline]      ,[PhoneNumberHotlineDescription]
      ,[PhoneNumberHotlineIsPrivate]      ,[PhoneNumberBusinessLine]      ,[PhoneNumberBusinessLineDescription]      ,[PhoneNumberBusinessLineIsPrivate]
      ,[PhoneNumberOutOfArea]      ,[PhoneNumberOutOfAreaDescription]      ,[PhoneNumberOutOfAreaIsPrivate]      ,[PhoneNumberAfterHours]
      ,[PhoneNumberAfterHoursDescription]      ,[PhoneNumberAfterHoursIsPrivate]      ,[EmailAddressMain]      ,[WebsiteAddress]
      ,[AgencyDescription]      ,[CoverageArea]      ,[CoverageAreaText]      ,[FeeStructureSource]      ,[ApplicationProcess]
      ,[DocumentsRequired]      ,[LanguagesOffered]      ,[LanguagesOfferedList]      ,[ConnectsToSiteNum]      ,[ConnectsToProgramNum]
      ,[LanguageOfRecord]      ,[TaxonomyTerm]      ,[TaxonomyTerms]      ,[TaxonomyCodes]      ,[Coverage]      ,[WorkHours]
      ,[CustomServicesToLGBTQ]      ,[CustomAutomatedStatus]      ,[CustomEligibilitybyAge]      ,[CustomEligibilityByGender]      ,[CustomLanguagePrefer]
      ,[CustomBilingualService]      ,[CustomManualStatus]      ,[CustomMCYSAccountNumber]      ,[CustomAnonymityPolicy]      ,[CustomSuggestKeyword]
      ,[CustomRecordType]      ,[createdDate]
  FROM [RAM].[dbo].[ETLLoad] 
END
GO






















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'new_select_interest_fields_by_Fuzzy_PublicName')
DROP PROCEDURE new_select_interest_fields_by_Fuzzy_PublicName
GO
-- =========================================================================================
-- Author:		William Chen
-- Create date: Sept.15, 2015
-- Description:	Select the most interesting fields from ETLLOAD TABLE by Fuzzy public Name
-- =========================================================================================
CREATE PROCEDURE  new_select_interest_fields_by_Fuzzy_PublicName
@publicname nvarchar(255) = N''
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT [ETLLoadID]
      ,[ResourceAgencyNum]      ,[PublicName]      ,[TaxonomyLevelName]      ,[ParentAgency]      ,[ParentAgencyNum]      ,[MailingAttentionName]
      ,[MailingAddress1]      ,[MailingAddress2]      ,[MailingCity]      ,[MailingStateProvince]
      ,[MailingPostalCode]      ,[MailingCountry]      ,[MailingAddressIsPrivate]      ,[PhysicalAddress1]
      ,[PhysicalAddress2]      ,[PhysicalCity]      ,[PhysicalCounty]      ,[PhysicalStateProvince]      ,[PhysicalPostalCode]
      ,[PhysicalCountry]      ,[PhysicalAddressIsPrivate]      ,[OtherAddress1]      ,[OtherAddress2]      ,[OtherCity]      ,[OtherCounty]
      ,[OtherStateProvince]      ,[OtherPostalCode]      ,[OtherCountry]      ,[Latitude]      ,[Longitude]      ,[HoursOfOperation]
      ,[Phone1Number]      ,[Phone1Name]      ,[Phone1Description]      ,[Phone1IsPrivate]      ,[Phone1Type]      ,[Phone2Number]      ,[Phone2Name]
      ,[Phone2Description]      ,[Phone2IsPrivate]      ,[Phone2Type]      ,[Phone3Number]      ,[Phone3Name]      ,[Phone3Description]
      ,[Phone3IsPrivate]      ,[Phone3Type]      ,[Phone4Number]      ,[Phone4Name]      ,[Phone4Description]      ,[Phone4IsPrivate]
      ,[Phone4Type]      ,[Phone5Number]      ,[Phone5Name]      ,[Phone5Description]      ,[Phone5IsPrivate]      ,[Phone5Type]
      ,[PhoneFax]      ,[PhoneFaxDescription]      ,[PhoneFaxIsPrivate]      ,[PhoneTTY]      ,[PhoneTTYDescription]      ,[PhoneTTYIsPrivate]
      ,[PhoneTollFree]      ,[PhoneTollFreeDescription]      ,[PhoneTollFreeIsPrivate]      ,[PhoneNumberHotline]      ,[PhoneNumberHotlineDescription]
      ,[PhoneNumberHotlineIsPrivate]      ,[PhoneNumberBusinessLine]      ,[PhoneNumberBusinessLineDescription]      ,[PhoneNumberBusinessLineIsPrivate]
      ,[PhoneNumberOutOfArea]      ,[PhoneNumberOutOfAreaDescription]      ,[PhoneNumberOutOfAreaIsPrivate]      ,[PhoneNumberAfterHours]
      ,[PhoneNumberAfterHoursDescription]      ,[PhoneNumberAfterHoursIsPrivate]      ,[EmailAddressMain]      ,[WebsiteAddress]
      ,[AgencyDescription]      ,[CoverageArea]      ,[CoverageAreaText]      ,[FeeStructureSource]      ,[ApplicationProcess]
      ,[DocumentsRequired]      ,[LanguagesOffered]      ,[LanguagesOfferedList]      ,[ConnectsToSiteNum]      ,[ConnectsToProgramNum]
      ,[LanguageOfRecord]      ,[TaxonomyTerm]      ,[TaxonomyTerms]      ,[TaxonomyCodes]      ,[Coverage]      ,[WorkHours]
      ,[CustomServicesToLGBTQ]      ,[CustomAutomatedStatus]      ,[CustomEligibilitybyAge]      ,[CustomEligibilityByGender]      ,[CustomLanguagePrefer]
      ,[CustomBilingualService]      ,[CustomManualStatus]      ,[CustomMCYSAccountNumber]      ,[CustomAnonymityPolicy]      ,[CustomSuggestKeyword]
      ,[CustomRecordType]      ,[createdDate]
	  FROM ETLLoad
  WHERE PublicName like ''+'%'+ @publicname + '%' + ''
END
GO
















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Allow_Domain')
DROP PROCEDURE Proc_Get_Allow_Domain
GO
-- =============================================
-- Author:		William Chen
-- Create date: Nov.6, 2016
-- Description:	Get allowable domains
-- =============================================
CREATE PROCEDURE Proc_Get_Allow_Domain 
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT  [ACLWeb] FROM [dbo].[ACLWeb] WHERE [ACLWebActivity] = 1
END
GO

















IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Proc_Get_Allow_IP')
DROP PROCEDURE Proc_Get_Allow_IP
GO
-- =============================================
-- Author:		William Chen
-- Create date: Nov.6, 2016
-- Description:	Get all allowable IP addresses
-- =============================================
CREATE PROCEDURE Proc_Get_Allow_IP
WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT ACLIP FROM [ACLIP] WHERE ACLIPActivity = 1;
END
GO






-- ======================================================================================================
-- ======================================================================================================
--
--  Following are database level configurtation 
--
-- ======================================================================================================
-- ======================================================================================================
--- load thesaurus_file
EXEC sys.sp_fulltext_load_thesaurus_file 0;
GO

-- Change the stoplist for a fulltext index
ALTER FULLTEXT INDEX ON   [dbo].[KeyWords]
SET STOPLIST [freetext]
go


-- Repopulate FT Index after changing stoplist
ALTER FULLTEXT INDEX ON [dbo].[KeyWords] START UPDATE POPULATION
go

--- delete log file
ALTER DATABASE [RAM] SET RECOVERY SIMPLE
DBCC SHRINKFILE (RAM_Log, 0, TRUNCATEONLY)
GO
ALTER DATABASE [RAM] SET RECOVERY FULL
GO


/****** Object:  User [RAMUser]    Script Date: 25/05/2016 9:31:02 AM ******/
USE [RAM]
GO
DROP USER [RAMUser]
GO
/****** Create User [RAMUser] for Login    Script Date: 25/05/2016 9:31:02 AM ******/
USE [RAM]
GO
CREATE USER [ramuser] FOR LOGIN [ramuser]
GO
Use RAM
GO
-- Change default database of a login:
exec sp_defaultdb @loginame='RAMUser', @defdb='RAM'
GO
use RAM
GO
-- Changing the password of a login
 ALTER LOGIN RAMUser WITH PASSWORD = 'KidshelpWC15!';
USE [RAM]
GO
ALTER ROLE [db_datareader] ADD MEMBER [RAMUser]
GO
USE [RAM]
GO
ALTER ROLE [db_datawriter] ADD MEMBER [RAMUser]
GO
USE [RAM]
GO
ALTER ROLE [db_ddladmin] ADD MEMBER [RAMUser]
GO
USE [RAM]
GO
-- Make an user member of db_owner group:
ALTER ROLE [db_owner] ADD MEMBER [RAMUser]
GO




 





